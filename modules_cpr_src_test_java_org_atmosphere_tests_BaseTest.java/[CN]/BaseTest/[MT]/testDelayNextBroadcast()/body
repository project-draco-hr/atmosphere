{
  logger.info("{}: running test: testDelayNextBroadcast",getClass().getSimpleName());
  final CountDownLatch latch=new CountDownLatch(2);
  atmoServlet.framework().addAtmosphereHandler(ROOT,new AbstractHttpAtmosphereHandler(){
    AtomicBoolean b=new AtomicBoolean(false);
    AtomicInteger count=new AtomicInteger(0);
    private long currentTime;
    public void onRequest(    AtmosphereResource event) throws IOException {
      if (!b.getAndSet(true)) {
        event.suspend(-1,false);
      }
 else {
        currentTime=System.currentTimeMillis();
        if (count.get() < 4) {
          event.getBroadcaster().delayBroadcast("message-" + count.getAndIncrement() + " ");
        }
 else {
          event.getBroadcaster().broadcast("message-final");
        }
      }
    }
    public void onStateChange(    AtmosphereResourceEvent event) throws IOException {
      if (event.isResuming()) {
        return;
      }
      try {
        event.getResource().getResponse().getWriter().write((String)event.getMessage());
        event.getResource().getResponse().flushBuffer();
        event.getResource().resume();
      }
 catch (      Exception ex) {
        logger.error("failure resuming resource",ex);
      }
 finally {
        latch.countDown();
      }
    }
  }
,BroadcasterFactory.getDefault().get(DefaultBroadcaster.class,"suspend"));
  AsyncHttpClient c=new AsyncHttpClient();
  try {
    Future<Response> f=c.prepareGet(urlTarget).execute();
    latch.await(5,TimeUnit.SECONDS);
    c.prepareGet(urlTarget).execute().get();
    c.prepareGet(urlTarget).execute().get();
    c.prepareGet(urlTarget).execute().get();
    c.prepareGet(urlTarget).execute().get();
    c.prepareGet(urlTarget).execute().get();
    Response r=f.get(10,TimeUnit.SECONDS);
    assertNotNull(r);
    assertEquals(r.getResponseBody(),"message-0 message-1 message-2 message-3 message-final");
    assertEquals(r.getStatusCode(),200);
  }
 catch (  Exception e) {
    logger.error("test failed",e);
    fail(e.getMessage());
  }
  c.close();
}
