{
  String uuid=r.getRequest().getHeader(HeaderConfig.X_ATMOSPHERE_TRACKING_ID);
  String handshakeUUID=r.getRequest().getHeader(HeaderConfig.X_ATMO_PROTOCOL);
  if (uuid != null && uuid.equals("0") && handshakeUUID != null) {
    r.getRequest().header(HeaderConfig.X_ATMO_PROTOCOL,null);
    r.addEventListener(new AtmosphereResourceEventListenerAdapter(){
      @Override public void onSuspend(      AtmosphereResourceEvent event){
        r.getResponse().write(r.uuid() + wsDelimiter + System.currentTimeMillis());
        if (r.transport() == AtmosphereResource.TRANSPORT.LONG_POLLING || r.transport() == AtmosphereResource.TRANSPORT.JSONP) {
          r.resume();
        }
 else {
          try {
            r.getResponse().flushBuffer();
          }
 catch (          IOException e) {
            logger.trace("",e);
          }
        }
      }
    }
);
  }
  return Action.CONTINUE;
}
