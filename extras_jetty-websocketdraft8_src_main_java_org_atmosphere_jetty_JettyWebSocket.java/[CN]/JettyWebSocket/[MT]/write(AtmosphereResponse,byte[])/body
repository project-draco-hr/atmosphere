{
  firstWrite.set(true);
  if (!outbound.isOpen())   throw new IOException("outbound remotely closed");
  logger.trace("WebSocket.write()");
  if (binaryWrite) {
    byte[] b=webSocketResponseFilter.filter(r,data);
    if (b != null) {
      outbound.sendMessage(frame,b,0,b.length);
    }
  }
 else {
    byte[] s=webSocketResponseFilter.filter(r,data);
    if (s != null) {
      outbound.sendMessage(new String(s,r.getCharacterEncoding()));
    }
  }
  lastWrite=System.currentTimeMillis();
  return this;
}
