{
  try {
    AtmosphereServlet.AtmosphereConfig config=bc.getBroadcasterConfig().getAtmosphereConfig();
    if (config != null) {
      if (config.getInitParameter(JMS_TOPIC) != null) {
        topicId=config.getInitParameter(JMS_TOPIC);
      }
      if (config.getInitParameter(JNDI_NAMESPACE) != null) {
        namespace=config.getInitParameter(JNDI_NAMESPACE);
      }
      if (config.getInitParameter(JNDI_FACTORY_NAME) != null) {
        factoryName=config.getInitParameter(JNDI_FACTORY_NAME);
      }
      if (config.getInitParameter(JNDI_TOPIC) != null) {
        topicId=config.getInitParameter(JNDI_TOPIC);
      }
    }
    String id=bc.getID();
    if (id.startsWith("/*")) {
      id="atmosphere";
    }
    logger.info(String.format("Looking up Connection Factory %s",namespace + factoryName));
    Context ctx=new InitialContext();
    ConnectionFactory connectionFactory=(ConnectionFactory)ctx.lookup(namespace + factoryName);
    logger.info(String.format("Looking up topic: %s",topicId));
    Topic topic=(Topic)ctx.lookup(namespace + topicId);
    connection=connectionFactory.createConnection();
    session=connection.createSession(false,Session.AUTO_ACKNOWLEDGE);
    logger.info(String.format("Create customer: %s",id));
    String selector=String.format("BroadcasterId = '%s'",id);
    consumer=session.createConsumer(topic,selector);
    consumer.setMessageListener(new MessageListener(){
      @Override public void onMessage(      Message msg){
        try {
          TextMessage textMessage=(TextMessage)msg;
          String message=textMessage.getText();
          if (message != null && bc != null) {
            receivedMessages.offer(message);
            bc.broadcast(message);
          }
        }
 catch (        JMSException ex) {
          if (logger.isLoggable(Level.WARNING)) {
            logger.log(Level.WARNING,"",ex);
          }
        }
      }
    }
);
    publisher=session.createProducer(topic);
    connection.start();
    logger.info(String.format("JMS created for topic %s, with filter %s",topicId,selector));
  }
 catch (  Throwable ex) {
    throw new IllegalStateException("Unable to initialize JMSBroadcaster",ex);
  }
}
