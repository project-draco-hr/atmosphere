{
  AtmosphereResourceEvent e=null;
synchronized (r) {
    if (!r.getAtmosphereResourceEvent().isSuspended())     return;
    trackBroadcastMessage(r,msg);
    e=r.getAtmosphereResourceEvent();
    e.setMessage(msg);
    if (r instanceof AtmosphereEventLifecycle) {
      ((AtmosphereEventLifecycle)r).notifyListeners();
    }
    if (r.getAtmosphereResourceEvent() != null && !r.getAtmosphereResourceEvent().isCancelled() && HttpServletRequest.class.isAssignableFrom(r.getRequest().getClass())) {
      HttpServletRequest.class.cast(r.getRequest()).setAttribute(CometSupport.MAX_INACTIVE,(Long)System.currentTimeMillis());
    }
    broadcast(r,e);
  }
}
