{
  if (r == null) {
    logger.trace("Null AtmosphereResource passed inside a Set");
    return msg.message;
  }
  Object finalMsg=msg.message;
  if (AtmosphereResourceImpl.class.isAssignableFrom(r.getClass())) {
synchronized (r) {
      if (isAtmosphereResourceValid(r)) {
        if (bc.hasPerRequestFilters()) {
          BroadcastAction a=bc.filter(r,msg.message,msg.originalMessage);
          if (a.action() == BroadcastAction.ACTION.ABORT) {
            return null;
          }
          if (a.message() != msg.originalMessage) {
            finalMsg=a.message();
          }
        }
      }
 else {
        removeAtmosphereResource(r);
        BroadcasterFactory.getDefault().removeAllAtmosphereResource(r);
      }
      if (cache && cacheStrategy == BroadcasterCache.STRATEGY.AFTER_FILTER) {
        msg.message=finalMsg;
        trackBroadcastMessage(r,msg);
      }
    }
  }
  return finalMsg;
}
