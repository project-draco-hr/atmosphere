{
  if (r == null) {
    logger.trace("Null AtmosphereResource passed inside a Set");
    return msg.message;
  }
  Object finalMsg=msg.message;
  if (AtmosphereResourceImpl.class.isAssignableFrom(r.getClass())) {
    if (isAtmosphereResourceValid(r)) {
      if (bc.hasPerRequestFilters()) {
synchronized (r) {
          BroadcastAction a=bc.filter(r,msg.message,msg.originalMessage);
          if (a.action() == BroadcastAction.ACTION.ABORT) {
            return null;
          }
          if (a.message() != msg.originalMessage) {
            finalMsg=a.message();
          }
        }
      }
    }
 else {
      removeAtmosphereResource(r);
      BroadcasterFactory.getDefault().removeAllAtmosphereResource(r);
    }
  }
  return finalMsg;
}
