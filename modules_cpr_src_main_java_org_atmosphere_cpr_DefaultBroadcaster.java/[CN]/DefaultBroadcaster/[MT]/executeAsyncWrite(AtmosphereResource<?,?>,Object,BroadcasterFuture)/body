{
  if (resource.getAtmosphereResourceEvent().isCancelled()) {
    return;
  }
  final AtmosphereResourceEvent event=resource.getAtmosphereResourceEvent();
  event.setMessage(msg);
  try {
    if (resource.getAtmosphereResourceEvent() != null && !resource.getAtmosphereResourceEvent().isCancelled() && HttpServletRequest.class.isAssignableFrom(resource.getRequest().getClass())) {
      HttpServletRequest.class.cast(resource.getRequest()).setAttribute(CometSupport.MAX_INACTIVE,System.currentTimeMillis());
    }
  }
 catch (  Exception t) {
    logger.debug("Preventing corruption of a recycled request: resource" + resource,event);
    removeAtmosphereResource(resource);
    BroadcasterFactory.getDefault().removeAllAtmosphereResource(resource);
    return;
  }
  broadcast(resource,event);
  if (resource instanceof AtmosphereEventLifecycle) {
    ((AtmosphereEventLifecycle)resource).notifyListeners();
  }
  if (future != null) {
    future.done();
  }
}
