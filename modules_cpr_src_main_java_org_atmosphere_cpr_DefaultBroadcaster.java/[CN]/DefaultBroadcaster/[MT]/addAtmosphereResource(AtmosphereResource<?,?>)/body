{
  if (destroyed.get()) {
    logger.error("This Broadcaster has been destroyed and cannot be used");
    return r;
  }
  if (scope == SCOPE.REQUEST && requestScoped.getAndSet(true)) {
    throw new IllegalStateException("Broadcaster " + this + " cannot be used as its scope is set to REQUEST");
  }
  if (maxSuspendResource.get() > 0 && resources.size() <= maxSuspendResource.get()) {
    if (policy == POLICY.FIFO) {
      AtmosphereResource<?,?> resource=resources.poll();
      try {
        logger.warn("Too many resource. Forcing resume of {} ",resource);
        resource.resume();
      }
 catch (      Throwable t) {
        logger.warn("failed to resume resource {} ",resource,t);
      }
    }
 else     if (policy == POLICY.REJECT) {
      throw new RejectedExecutionException(String.format("Maximum suspended AtmosphereResources %s",maxSuspendResource));
    }
  }
  if (resources.contains(r)) {
    return r;
  }
  if (resources.isEmpty()) {
    BroadcasterFactory.getDefault().add(this,name);
  }
  resources.add(r);
  checkCachedAndPush(r,r.getAtmosphereResourceEvent());
  return r;
}
