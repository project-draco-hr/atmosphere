{
  if (destroyed.get()) {
    logger.debug(DESTROYED,getID(),"setScope");
    return;
  }
  this.scope=scope;
  if (scope != SCOPE.REQUEST) {
    return;
  }
  logger.debug("Changing broadcaster scope for {}. This broadcaster will be destroyed.",getID());
synchronized (resources) {
    try {
      for (      AtmosphereResource<?,?> resource : resources) {
        Broadcaster b=BroadcasterFactory.getDefault().get(getClass(),getClass().getSimpleName() + "/" + UUID.randomUUID());
        if (DefaultBroadcaster.class.isAssignableFrom(this.getClass())) {
          BroadcasterCache cache=bc.getBroadcasterCache().getClass().newInstance();
          InjectorProvider.getInjector().inject(cache);
          DefaultBroadcaster.class.cast(b).broadcasterCache=cache;
          DefaultBroadcaster.class.cast(b).getBroadcasterConfig().setBroadcasterCache(cache);
        }
        resource.setBroadcaster(b);
        b.setScope(SCOPE.REQUEST);
        if (resource.getAtmosphereResourceEvent().isSuspended()) {
          b.addAtmosphereResource(resource);
        }
        logger.debug("Resource {} not using broadcaster {}",resource,b.getID());
      }
      if (resources.isEmpty()) {
        return;
      }
      destroy();
    }
 catch (    Exception e) {
      logger.error("Failed to set request scope for current resources",e);
    }
  }
}
