{
  recentActivity.set(true);
  String prevMessage=entry.message.toString();
  if (rec && !delayedBroadcast.isEmpty()) {
    Iterator<Entry> i=delayedBroadcast.iterator();
    StringBuilder b=new StringBuilder();
    while (i.hasNext()) {
      Entry e=i.next();
      e.future.cancel(true);
      try {
        if (e.message instanceof String && entry.message instanceof String) {
          b.append(e.message);
        }
 else {
          deliverPush(e,false);
        }
      }
  finally {
        i.remove();
      }
    }
    if (b.length() > 0) {
      entry.message=b.append(entry.message).toString();
    }
  }
  Object finalMsg=callable(entry.message);
  if (finalMsg == null) {
    logger.error("Callable exception. Please catch all exception from you callable. Message {} will be lost and all AtmosphereResource " + "associated with this Broadcaster resumed.",entry.message);
    entryDone(entry.future);
synchronized (resources) {
      for (      AtmosphereResource r : resources) {
        if (r.transport().equals(AtmosphereResource.TRANSPORT.JSONP) || r.transport().equals(AtmosphereResource.TRANSPORT.LONG_POLLING))         try {
          r.resume();
        }
 catch (        Throwable t) {
          logger.trace("resumeAll",t);
        }
      }
    }
    return;
  }
  Object prevM=entry.originalMessage;
  entry.originalMessage=(entry.originalMessage != entry.message ? callable(entry.originalMessage) : finalMsg);
  if (entry.originalMessage == null) {
    logger.trace("Broadcast message was null {}",prevM);
    entryDone(entry.future);
    return;
  }
  entry.message=finalMsg;
  entry.cache=bc.getBroadcasterCache().addToCache(getID(),null,new BroadcastMessage(entry.originalMessage));
  if (resources.isEmpty()) {
    if (resources.isEmpty()) {
      logger.trace("Broadcaster {} doesn't have any associated resource. " + "Message will be cached in the configured BroadcasterCache {}",getID(),entry.message);
      AtmosphereResource r=null;
      if (entry.type == Entry.TYPE.RESOURCE) {
        r=entry.resource;
      }
      if (r == null) {
        r=noOpsResource;
      }
      entryDone(entry.future);
      return;
    }
  }
  try {
    if (logger.isTraceEnabled()) {
      for (      AtmosphereResource r : resources) {
        logger.trace("AtmosphereResources available for {}",r.uuid());
      }
    }
switch (entry.type) {
case ALL:
      for (      AtmosphereResource r : resources) {
        boolean deliverMessage=perRequestFilter(r,entry,true);
        if (!deliverMessage || entry.message == null) {
          logger.debug("Skipping broadcast delivery resource {} ",r);
          continue;
        }
        if (entry.writeLocally) {
          queueWriteIO(r,entry);
        }
      }
    break;
case RESOURCE:
  boolean deliverMessage=perRequestFilter(entry.resource,entry,true);
if (!deliverMessage || entry.message == null) {
  logger.debug("Skipping broadcast delivery resource {} ",entry.resource);
  return;
}
if (entry.writeLocally) {
queueWriteIO(entry.resource,entry);
}
break;
case SET:
if (entry.resources.size() != 0) {
for (AtmosphereResource r : entry.resources) {
deliverMessage=perRequestFilter(r,entry,true);
if (!deliverMessage || entry.message == null) {
logger.debug("Skipping broadcast delivery resource {} ",r);
continue;
}
if (entry.writeLocally) {
queueWriteIO(r,entry);
}
}
}
break;
}
entry.message=prevMessage;
}
 catch (InterruptedException ex) {
logger.debug(ex.getMessage(),ex);
}
}
