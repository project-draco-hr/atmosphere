{
  recentActivity.set(true);
  String prevMessage=entry.message.toString();
  if (rec && !delayedBroadcast.isEmpty()) {
    Iterator<Entry> i=delayedBroadcast.iterator();
    StringBuilder b=new StringBuilder();
    while (i.hasNext()) {
      Entry e=i.next();
      e.future.cancel(true);
      try {
        if (e.message instanceof String && entry.message instanceof String) {
          b.append(e.message);
        }
 else {
          deliverPush(e,false);
        }
      }
  finally {
        i.remove();
      }
    }
    if (b.length() > 0) {
      entry.message=b.append(entry.message).toString();
    }
  }
  Object finalMsg=translate(entry.message);
  if (finalMsg == null) {
    logger.trace("Broascast message was null {}",finalMsg);
    entryDone(entry.future);
    return;
  }
  Object prevM=entry.originalMessage;
  entry.originalMessage=(entry.originalMessage != entry.message ? translate(entry.originalMessage) : finalMsg);
  if (entry.originalMessage == null) {
    logger.debug("Broascast message was null {}",prevM);
    entryDone(entry.future);
    return;
  }
  entry.message=finalMsg;
  if (resources.isEmpty()) {
    logger.debug("Broadcaster {} doesn't have any associated resource. Message will be cached in the configured BroadcasterCache",getID());
    AtmosphereResource r=null;
    if (entry.multipleAtmoResources != null && AtmosphereResource.class.isAssignableFrom(entry.multipleAtmoResources.getClass())) {
      r=AtmosphereResource.class.cast(entry.multipleAtmoResources);
    }
    trackBroadcastMessage(r,entry);
    entryDone(entry.future);
    return;
  }
  try {
    if (entry.multipleAtmoResources == null) {
      for (      AtmosphereResource r : resources) {
        finalMsg=perRequestFilter(r,entry,true);
        if (finalMsg == null) {
          logger.debug("Skipping broadcast delivery resource {} ",r);
          continue;
        }
        if (entry.writeLocally) {
          queueWriteIO(r,finalMsg,entry);
        }
      }
    }
 else     if (entry.multipleAtmoResources instanceof AtmosphereResource) {
      finalMsg=perRequestFilter((AtmosphereResource)entry.multipleAtmoResources,entry,true);
      if (finalMsg == null) {
        logger.debug("Skipping broadcast delivery resource {} ",entry.multipleAtmoResources);
        return;
      }
      if (entry.writeLocally) {
        queueWriteIO((AtmosphereResource)entry.multipleAtmoResources,finalMsg,entry);
      }
    }
 else     if (entry.multipleAtmoResources instanceof Set) {
      Set<AtmosphereResource> sub=(Set<AtmosphereResource>)entry.multipleAtmoResources;
      if (sub.size() != 0) {
        for (        AtmosphereResource r : sub) {
          finalMsg=perRequestFilter(r,entry,true);
          if (finalMsg == null) {
            logger.debug("Skipping broadcast delivery resource {} ",r);
            continue;
          }
          if (entry.writeLocally) {
            queueWriteIO(r,finalMsg,entry);
          }
        }
      }
 else {
        if (cacheStrategy == BroadcasterCache.STRATEGY.AFTER_FILTER) {
          entry.message=finalMsg;
          trackBroadcastMessage(null,entry);
        }
      }
    }
    entry.message=prevMessage;
  }
 catch (  InterruptedException ex) {
    logger.debug(ex.getMessage(),ex);
  }
}
