{
  WebSocketHandler webSocketHandler=webSocket.webSocketHandler();
  if (webSocketHandler == null) {
    if (!WebSocketProtocolStream.class.isAssignableFrom(webSocketProtocol.getClass())) {
      List<AtmosphereRequest> list=webSocketProtocol.onMessage(webSocket,webSocketMessage);
      dispatch(webSocket,list);
    }
 else {
      logger.debug("The WebServer doesn't support streaming. Wrapping the message as stream.");
      invokeWebSocketProtocol(webSocket,new StringReader(webSocketMessage));
      return;
    }
  }
 else {
    if (!WebSocketStreamingHandler.class.isAssignableFrom(webSocketHandler.getClass())) {
      AtmosphereResource r=webSocket.resource();
      try {
        webSocketHandler.onTextMessage(webSocket,webSocketMessage);
      }
 catch (      Exception ex) {
        logger.error("",ex);
        webSocketHandler.onError(webSocket,new WebSocketException(ex,new AtmosphereResponse.Builder().request(r != null ? r.getRequest() : null).status(500).statusMessage("Server Error").build()));
      }
    }
 else {
      logger.debug("The WebServer doesn't support streaming. Wrapping the message as stream.");
      invokeWebSocketProtocol(webSocket,new StringReader(webSocketMessage));
      return;
    }
  }
  notifyListener(webSocket,new WebSocketEventListener.WebSocketEvent(webSocketMessage,MESSAGE,webSocket));
}
