{
  if (handler == null) {
    state=ConnectionState.CLOSED;
    atmosphereHandler=null;
    socketIOSessions.remove(sessionId);
  }
 else   if (this.handler == null) {
    this.handler=handler;
    try {
      state=ConnectionState.CONNECTED;
      resource.getRequest().setAttribute(SocketIOAtmosphereHandler.SOCKETIO_SESSION_ID,sessionId);
      resource.getRequest().setAttribute(SocketIOAtmosphereHandler.SOCKETIO_SESSION_OUTBOUND,handler);
      startHeartbeatTimer();
synchronized (atmosphereHandler) {
        if (SocketIOAtmosphereHandler.class.isAssignableFrom(atmosphereHandler.getClass())) {
          SocketIOAtmosphereHandler.class.cast(atmosphereHandler).onConnect(resource,handler);
        }
 else {
          atmosphereHandler.onRequest(resource);
        }
      }
    }
 catch (    Throwable e) {
      logger.error("Session[" + sessionId + "]: Exception thrown by SocketIOInbound.onConnect()",e);
      state=ConnectionState.CLOSED;
      handler.abort();
    }
  }
 else {
    handler.abort();
  }
}
