{
  AtmosphereRequest req=r.getRequest();
  AtmosphereResponse res=r.getResponse();
  String method=req.getMethod();
  if ("GET".equalsIgnoreCase(method)) {
    r.addEventListener(new WebSocketEventListenerAdapter());
    res.setContentType("text/html;charset=ISO-8859-1");
    Broadcaster b=lookupBroadcaster(req.getPathInfo());
    r.setBroadcaster(b).suspend(-1);
  }
 else   if ("POST".equalsIgnoreCase(method)) {
    Broadcaster b=lookupBroadcaster(req.getPathInfo());
    String message=req.getReader().readLine();
    if (message != null && message.indexOf("message") != -1) {
      b.broadcast(message.substring("message=".length()));
    }
  }
}
