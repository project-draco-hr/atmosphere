{
  HttpServletRequest req=r.getRequest();
  HttpServletResponse res=r.getResponse();
  String method=req.getMethod();
  if ("GET".equalsIgnoreCase(method)) {
    String trackingId=trackingId(req);
    r.addEventListener(new WebSocketEventListenerAdapter());
    res.setContentType("text/html;charset=ISO-8859-1");
    Broadcaster b=lookupBroadcaster(req.getPathInfo());
    r.setBroadcaster(b);
    if (req.getHeader(HeaderConfig.X_ATMOSPHERE_TRANSPORT).equalsIgnoreCase(HeaderConfig.LONG_POLLING_TRANSPORT)) {
      req.setAttribute(ApplicationConfig.RESUME_ON_BROADCAST,Boolean.TRUE);
      r.suspend(-1,false);
    }
 else {
      r.suspend(-1);
    }
  }
 else   if ("POST".equalsIgnoreCase(method)) {
    Broadcaster b=lookupBroadcaster(req.getPathInfo());
    String message=req.getReader().readLine();
    if (message != null && message.indexOf("message") != -1) {
      b.broadcast(message.substring("message=".length()));
    }
  }
}
