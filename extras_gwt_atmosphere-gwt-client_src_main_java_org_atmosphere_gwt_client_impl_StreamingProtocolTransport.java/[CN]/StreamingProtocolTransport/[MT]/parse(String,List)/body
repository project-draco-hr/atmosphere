{
  if (expectingDisconnection) {
    listener.onError(new AtmosphereClientException("Expecting disconnection but received message: " + message),true);
  }
 else   if (message.isEmpty()) {
    listener.onError(new AtmosphereClientException("Invalid empty message received"),true);
  }
 else {
    char c=message.charAt(0);
switch (c) {
case '!':
      String initParameters=message.substring(1);
    try {
      String[] params=initParameters.split(":");
      connectionId=Integer.parseInt(params[1]);
      listener.onConnected(Integer.parseInt(params[0]),connectionId);
    }
 catch (    NumberFormatException e) {
      listener.onError(new AtmosphereClientException("Unexpected init parameters: " + initParameters),true);
    }
  break;
case '$':
String parameters=message.substring(1);
try {
String[] params=parameters.split(":");
int statusCode=Integer.parseInt(params[0]);
expectingDisconnection=true;
listener.onError(new StatusCodeException(statusCode,params[1]),false);
}
 catch (NumberFormatException e) {
listener.onError(new AtmosphereClientException("Unexpected error parameters: " + parameters),true);
}
break;
case '?':
expectingDisconnection=true;
break;
case '#':
listener.onHeartbeat();
break;
case '@':
listener.onRefresh();
break;
case '*':
break;
case '|':
messages.add(message.substring(1));
break;
case ']':
messages.add(unescape(message.substring(1)));
break;
case '[':
case 'R':
case 'r':
case 'f':
try {
messages.add(parse(message));
}
 catch (SerializationException e) {
listener.onError(e,true);
}
break;
default :
listener.onError(new AtmosphereClientException("Invalid message received: " + message),true);
}
}
}
