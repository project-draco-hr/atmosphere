{
  AtmosphereServlet.Action action=null;
  action=suspended(req,res);
  if (action.type == AtmosphereServlet.Action.TYPE.SUSPEND) {
    logger.debug("Suspending response: {}",res);
    req.setAttribute(SUSPEND,new Boolean(true));
    req.setAttribute(HOOK,new CometSupportHook(req,res));
  }
 else   if (action.type == AtmosphereServlet.Action.TYPE.RESUME) {
    logger.debug("Resuming response: {}",res);
    AtmosphereServlet.Action nextAction=resumed(req,res);
    if (nextAction.type == AtmosphereServlet.Action.TYPE.SUSPEND) {
      logger.debug("Suspending after resuming response: {}",res);
      req.setAttribute(SUSPEND,new Boolean(true));
    }
  }
  return action;
}
