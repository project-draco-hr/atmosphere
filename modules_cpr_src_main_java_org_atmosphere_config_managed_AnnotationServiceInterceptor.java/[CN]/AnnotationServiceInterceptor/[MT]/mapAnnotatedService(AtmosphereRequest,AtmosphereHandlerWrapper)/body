{
  String path;
  String pathInfo=null;
  try {
    pathInfo=request.getPathInfo();
  }
 catch (  IllegalStateException ex) {
  }
  if (pathInfo != null) {
    path=request.getServletPath() + pathInfo;
  }
 else {
    path=request.getServletPath();
  }
  if (path == null || path.isEmpty()) {
    path="/";
  }
  config.getBroadcasterFactory().remove(w.broadcaster.getID());
synchronized (config.handlers()) {
    if (config.handlers().get(path) == null) {
      if (AnnotatedProxy.class.isAssignableFrom(w.atmosphereHandler.getClass())) {
        AnnotatedProxy ap=AnnotatedProxy.class.cast(w.atmosphereHandler);
        if (ap.target().getClass().getAnnotation(ManagedService.class) != null) {
          String targetPath=ap.target().getClass().getAnnotation(ManagedService.class).path();
          if (targetPath.indexOf("{") != -1 && targetPath.indexOf("}") != -1) {
            try {
synchronized (config.handlers()) {
                boolean singleton=ap.target().getClass().getAnnotation(Singleton.class) != null;
                if (!singleton) {
                  ManagedAtmosphereHandler h=(ManagedAtmosphereHandler)w.atmosphereHandler.getClass().getConstructor(Object.class).newInstance(ap.target().getClass().newInstance());
                  AnnotationServiceInterceptor m=null;
                  for (                  AtmosphereInterceptor i : w.interceptors) {
                    if (AnnotationServiceInterceptor.class.isAssignableFrom(i.getClass())) {
                      m=AnnotationServiceInterceptor.class.cast(i);
                      break;
                    }
                  }
                  List<AtmosphereInterceptor> interceptors=new ArrayList<AtmosphereInterceptor>();
                  interceptors.addAll(w.interceptors);
                  interceptors.remove(m);
                  interceptors.add(new AnnotationServiceInterceptor(h));
                  config.framework().addAtmosphereHandler(path,h,interceptors);
                }
 else {
                  config.framework().addAtmosphereHandler(path,w.atmosphereHandler);
                }
              }
              request.setAttribute(FrameworkConfig.NEW_MAPPING,"true");
            }
 catch (            Throwable e) {
              logger.warn("Unable to create AtmosphereHandler",e);
            }
          }
        }
      }
      if (w.atmosphereHandler.getClass().getAnnotation(AtmosphereHandlerService.class) != null) {
        String targetPath=w.atmosphereHandler.getClass().getAnnotation(AtmosphereHandlerService.class).path();
        if (targetPath.indexOf("{") != -1 && targetPath.indexOf("}") != -1) {
          try {
            boolean singleton=w.atmosphereHandler.getClass().getAnnotation(Singleton.class) != null;
            if (!singleton) {
              config.framework().addAtmosphereHandler(path,w.atmosphereHandler.getClass().newInstance());
            }
 else {
              config.framework().addAtmosphereHandler(path,w.atmosphereHandler);
            }
            request.setAttribute(FrameworkConfig.NEW_MAPPING,"true");
          }
 catch (          Throwable e) {
            logger.warn("Unable to create AtmosphereHandler",e);
          }
        }
      }
      if (ReflectorServletProcessor.class.isAssignableFrom(w.atmosphereHandler.getClass())) {
        Servlet s=ReflectorServletProcessor.class.cast(w.atmosphereHandler).getServlet();
        if (s.getClass().getAnnotation(MeteorService.class) != null) {
          String targetPath=s.getClass().getAnnotation(MeteorService.class).path();
          if (targetPath.indexOf("{") != -1 && targetPath.indexOf("}") != -1) {
            try {
              boolean singleton=s.getClass().getAnnotation(Singleton.class) != null;
              if (!singleton) {
                ReflectorServletProcessor r=new ReflectorServletProcessor();
                r.setServlet(s.getClass().newInstance());
                r.init(config.getServletConfig());
                config.framework().addAtmosphereHandler(path,r);
              }
 else {
                config.framework().addAtmosphereHandler(path,w.atmosphereHandler);
              }
              request.setAttribute(FrameworkConfig.NEW_MAPPING,"true");
            }
 catch (            Throwable e) {
              logger.warn("Unable to create AtmosphereHandler",e);
            }
          }
        }
      }
    }
  }
}
