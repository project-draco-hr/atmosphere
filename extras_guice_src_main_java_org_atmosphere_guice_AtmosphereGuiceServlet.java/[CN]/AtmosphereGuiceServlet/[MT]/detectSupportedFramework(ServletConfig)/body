{
  Injector injector=(Injector)framework().getAtmosphereConfig().getServletContext().getAttribute(Injector.class.getName());
  GuiceContainer guiceServlet=injector.getInstance(GuiceContainer.class);
  framework().setUseStreamForFlushingComments(false);
  ReflectorServletProcessor rsp=new ReflectorServletProcessor();
  framework().setDefaultBroadcasterClassName(FrameworkConfig.JERSEY_BROADCASTER);
  framework().setUseStreamForFlushingComments(true);
  rsp.setServlet(guiceServlet);
  if (sc.getServletContext().getAttribute(SKIP_GUICE_FILTER) == null) {
    rsp.setFilterClassName(GUICE_FILTER);
  }
  framework().getAtmosphereConfig().setSupportSession(false);
  String mapping=sc.getInitParameter(ApplicationConfig.PROPERTY_SERVLET_MAPPING);
  if (mapping == null) {
    mapping="/*";
  }
  try {
    Map<String,String> props=injector.getInstance(Key.get(new TypeLiteral<Map<String,String>>(){
    }
,Names.named(JERSEY_PROPERTIES)));
    if (props != null) {
      for (      String p : props.keySet()) {
        framework().addInitParameter(p,props.get(p));
      }
    }
  }
 catch (  Exception ex) {
    logger.debug("failed to add Jersey init parameters to Atmosphere servlet",ex);
  }
  framework().addAtmosphereHandler(mapping,rsp);
  guiceInstalled=true;
  return true;
}
