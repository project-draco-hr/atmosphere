{
  if (!isCancelled.getAndSet(true)) {
    logger.trace("Cancelling {}",uuid);
    SessionTimeoutSupport.restoreTimeout(req);
    action.type(Action.TYPE.CANCELLED);
    if (asyncSupport != null)     asyncSupport.action(this);
    if (AtmosphereResponse.class.isAssignableFrom(response.getClass())) {
      AtmosphereResponse.class.cast(response).close();
      AtmosphereResponse.class.cast(response).destroy();
    }
    if (AtmosphereRequest.class.isAssignableFrom(req.getClass())) {
      AtmosphereRequest.class.cast(req).destroy();
    }
    if (config.getBroadcasterFactory().getDefault() != null) {
      config.getBroadcasterFactory().getDefault().removeAllAtmosphereResource(this);
    }
    req.removeAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
    event.destroy();
  }
}
