{
  if (!isCancelled.getAndSet(true)) {
    logger.trace("Cancelling {}",uuid);
    if (action.type() == Action.TYPE.CANCELLED || action.type() == Action.TYPE.SUSPEND) {
      SessionTimeoutSupport.restoreTimeout(req);
    }
    action.type(Action.TYPE.RESUME);
    if (asyncSupport != null)     asyncSupport.action(this);
    if (AtmosphereResponse.class.isAssignableFrom(response.getClass())) {
      AtmosphereResponse.class.cast(response).close();
      AtmosphereResponse.class.cast(response).destroy();
    }
    if (AtmosphereRequest.class.isAssignableFrom(req.getClass())) {
      AtmosphereRequest.class.cast(req).destroy();
    }
    if (broadcaster != null) {
      broadcaster.removeAtmosphereResource(this);
    }
    event.destroy();
  }
}
