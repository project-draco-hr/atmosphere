{
  if (!isCancelled.getAndSet(true)) {
    logger.trace("Cancelling {}",uuid);
    if (config.getBroadcasterFactory().getDefault() != null) {
      config.getBroadcasterFactory().getDefault().removeAllAtmosphereResource(this);
      if (transport.equals(TRANSPORT.WEBSOCKET)) {
        String parentUUID=(String)req.getAttribute(SUSPENDED_ATMOSPHERE_RESOURCE_UUID);
        AtmosphereResource p=AtmosphereResourceFactory.getDefault().find(parentUUID);
        if (p != null) {
          config.getBroadcasterFactory().getDefault().removeAllAtmosphereResource(p);
        }
      }
    }
    asyncSupport.complete(this);
    SessionTimeoutSupport.restoreTimeout(req);
    action.type(Action.TYPE.CANCELLED);
    if (asyncSupport != null)     asyncSupport.action(this);
    if (AtmosphereResponse.class.isAssignableFrom(response.getClass())) {
      AtmosphereResponse.class.cast(response).close();
      AtmosphereResponse.class.cast(response).destroy();
    }
    if (AtmosphereRequest.class.isAssignableFrom(req.getClass())) {
      AtmosphereRequest.class.cast(req).destroy();
    }
    req.removeAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
    event.destroy();
  }
}
