{
  if (!event.isResumedOnTimeout()) {
    String upgrade=req.getHeader("Connection");
    if (upgrade != null && upgrade.equalsIgnoreCase("Upgrade")) {
      if (!cometSupport.supportWebSocket()) {
        res.addHeader("X-Atmosphere-error","Websocket protocol not supported");
      }
 else {
        flushComment=false;
      }
    }
    res.setHeader("Expires","-1");
    res.setHeader("Cache-Control","no-store, no-cache, must-revalidate");
    res.setHeader("Pragma","no-cache");
    if (flushComment) {
      write();
    }
    req.setAttribute(PRE_SUSPEND,"true");
    action.type=AtmosphereServlet.Action.TYPE.SUSPEND;
    action.timeout=timeout;
    broadcaster.addAtmosphereResource(this);
    req.removeAttribute(PRE_SUSPEND);
    notifyListeners();
  }
}
