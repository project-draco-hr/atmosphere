{
  Action action=null;
  try {
    action=suspended(req,res);
    if (action.type == Action.TYPE.SUSPEND) {
      logger.debug("Suspending response: {}",res);
      suspend(action,req,res);
    }
 else     if (action.type == Action.TYPE.RESUME) {
      logger.debug("Resuming response: {}",res);
      int latchId=(req.getAttribute(LATCH) == null ? 0 : (Integer)req.getAttribute(LATCH));
      if (req.getSession(false) != null && req.getSession(false).getAttribute(LATCH) != null) {
        latchId=(Integer)req.getSession(false).getAttribute(LATCH);
      }
      CountDownLatch latch=latchs.get(latchId);
      if (latch == null && req.getAttribute(AtmosphereResourceImpl.PRE_SUSPEND) == null) {
        logger.debug("response wasn't suspended: {}",res);
        return action;
      }
      latch.countDown();
      Action nextAction=resumed(req,res);
      if (nextAction.type == Action.TYPE.SUSPEND) {
        logger.debug("Suspending after resuming response: {}",res);
        suspend(action,req,res);
      }
    }
  }
  finally {
    try {
      CometEvent event=(CometEvent)req.getAttribute(TomcatCometSupport.COMET_EVENT);
      if (event != null) {
        event.close();
      }
    }
 catch (    ClassCastException ex) {
      org.apache.catalina.connector.CometEventImpl event=(org.apache.catalina.connector.CometEventImpl)req.getAttribute(TomcatCometSupport.COMET_EVENT);
      if (event != null) {
        event.close();
      }
    }
    HttpEvent he=(HttpEvent)req.getAttribute(JBossWebCometSupport.HTTP_EVENT);
    if (he != null) {
      he.close();
    }
  }
  return action;
}
