{
  final CountDownLatch latch=new CountDownLatch(1);
  req.setAttribute(LATCH,latch);
  boolean ok=true;
  try {
    AtmosphereResource resource=req.resource();
    resource.addEventListener(new AtmosphereResourceEventListenerAdapter(){
      @Override public void onResume(      AtmosphereResourceEvent event){
        latch.countDown();
      }
    }
);
    if (action.timeout() != -1) {
      ok=latch.await(action.timeout(),TimeUnit.MILLISECONDS);
    }
 else {
      latch.await();
    }
  }
 catch (  InterruptedException ex) {
    logger.trace("",ex);
  }
 finally {
    if (!ok) {
      timedout(req,res);
    }
 else {
      if (req.resource() != null) {
        AtmosphereResourceImpl.class.cast(req.resource()).cancel();
      }
    }
  }
}
