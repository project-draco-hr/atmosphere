{
  if (outbound == null || message == null || message.length() == 0) {
    return;
  }
  AtmosphereRequest request=r.getRequest();
  try {
    logger.debug("onMessage on SessionID=" + outbound.getSessionId() + "  : Message Received = "+ message);
    ChatJSONObject chat=mapper.readValue(message,ChatJSONObject.class);
    if (ChatJSONObject.LOGIN.equalsIgnoreCase(chat.name)) {
      request.getSession().setAttribute("LOGINNAME",chat.getArgs().toArray()[0]);
      String username=(String)chat.getArgs().toArray()[0];
      if (loggedUserMap.containsValue(username)) {
        outbound.sendMessage(new SocketIOPacketImpl(PacketType.ACK,"1+[true]").toString());
      }
 else {
        loggedUserMap.put(outbound.getSessionId(),username);
        try {
          ChatJSONObject out=new ChatJSONObject();
          out.setName(ChatJSONObject.USERCONNECTEDLIST);
          List list=new ArrayList();
          list.add(loggedUserMap);
          out.setArgs(list);
          List<SocketIOPacketImpl> loginMessagesList=new ArrayList(2);
          loginMessagesList.add(new SocketIOPacketImpl(PacketType.ACK,"1+[false]"));
          loginMessagesList.add(new SocketIOPacketImpl(PacketType.EVENT,mapper.writeValueAsString(out)));
          outbound.sendMessage(loginMessagesList);
          broadcaster.broadcast(mapper.writeValueAsString(out),r);
          broadcaster.broadcast("{\"args\":[\"" + chat.getArgs().toArray()[0] + " connected\"],\"name\":\"announcement\"}",r);
        }
 catch (        Exception e) {
          logger.error("",e);
          outbound.disconnect();
        }
      }
    }
 else     if (ChatJSONObject.MESSAGE.equalsIgnoreCase(chat.name)) {
      String username=loggedUserMap.get(outbound.getSessionId());
      List<String> msg=new ArrayList<String>();
      msg.add(username);
      msg.addAll(chat.args);
      ChatJSONObject out=new ChatJSONObject();
      out.setName(ChatJSONObject.MESSAGE);
      out.setArgs(msg);
      broadcaster.broadcast(mapper.writeValueAsString(out),r);
    }
  }
 catch (  IOException e) {
    logger.error("",e);
  }
}
