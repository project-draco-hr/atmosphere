{
  if (refreshState != null) {
    if (transport == refreshTransport) {
      if (refreshState == RefreshState.PRIMARY_DISCONNECTED) {
        doneRefresh();
      }
 else       if (refreshState == RefreshState.CONNECTING) {
        primaryTransport.disconnect();
        doneRefresh();
      }
 else {
        throw new IllegalStateException("Unexpected refresh state");
      }
    }
 else {
      if (refreshState != RefreshState.CONNECTING) {
        throw new IllegalStateException("Unexpected refresh state");
      }
      refreshState=null;
      listener.onAfterRefresh();
    }
  }
 else {
    listener.onConnected(heartbeat,connectionID);
  }
}
