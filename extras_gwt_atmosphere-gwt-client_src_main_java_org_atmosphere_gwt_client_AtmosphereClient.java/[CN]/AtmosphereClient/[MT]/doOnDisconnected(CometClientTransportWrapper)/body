{
  if (refreshState != null) {
    if (transport == primaryTransport) {
      if (refreshState != RefreshState.CONNECTING && refreshState != RefreshState.PRIMARY_RECONNECT) {
        throw new IllegalStateException("Unexpected refreshState");
      }
      if (refreshState == RefreshState.PRIMARY_RECONNECT) {
        scheduleConnect(transport);
      }
 else {
        refreshState=RefreshState.PRIMARY_DISCONNECTED;
        logger.warning("primary disconnected before refresh transport was connected");
      }
    }
 else {
      failedRefresh();
    }
  }
 else {
    listener.onDisconnected();
    if (running) {
      scheduleConnect(transport);
    }
  }
}
