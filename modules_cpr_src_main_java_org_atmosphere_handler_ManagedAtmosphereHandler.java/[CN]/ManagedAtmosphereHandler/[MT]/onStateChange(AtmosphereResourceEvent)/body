{
  AtmosphereResource resource=event.getResource();
  if (event.isCancelled()) {
    invoke(onDisconnectMethod,resource);
  }
 else   if (event.isResumedOnTimeout() || event.isResuming()) {
    invoke(onTimeoutMethod,resource);
  }
 else {
    Object m=invoke(onMessageMethod,event.getMessage().toString());
    if (m != null) {
      super.onStateChange(event.setMessage(m));
    }
 else     if (onMessageMethod == null) {
      super.onStateChange(event);
    }
  }
  AtmosphereResourceImpl r=AtmosphereResourceImpl.class.cast(event.getResource());
  Boolean resumeOnBroadcast=r.resumeOnBroadcast();
  if (!resumeOnBroadcast) {
    Object o=r.getRequest(false).getAttribute(ApplicationConfig.RESUME_ON_BROADCAST);
    if (o != null && Boolean.class.isAssignableFrom(o.getClass())) {
      resumeOnBroadcast=Boolean.class.cast(o);
    }
  }
  if (resumeOnBroadcast != null && resumeOnBroadcast && r.isSuspended()) {
    r.resume();
  }
}
