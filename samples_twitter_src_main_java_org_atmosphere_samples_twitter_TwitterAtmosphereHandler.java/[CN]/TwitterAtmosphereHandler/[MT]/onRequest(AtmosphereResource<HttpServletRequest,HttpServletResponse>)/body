{
  HttpServletRequest request=atmoResource.getRequest();
  HttpServletResponse response=atmoResource.getResponse();
  String action=request.getParameter("action");
  String sessionId=request.getSession().getId();
  HttpSession session=request.getSession();
  Broadcaster myBroadcasterFollower=(Broadcaster)session.getAttribute(sessionId);
  if (action != null) {
    if ("login".equals(action)) {
      response.setContentType("text/plain");
      response.setCharacterEncoding("UTF-8");
      String name=request.getParameter("name");
      if (name == null) {
        logger.severe("Name cannot be null");
        return;
      }
      session.setAttribute("name",name);
      myBroadcasterFollower.broadcast(BEGIN_SCRIPT_TAG + toJsonp("Welcome back",name) + END_SCRIPT_TAG);
      atmoResource.getAtmosphereConfig().getServletContext().setAttribute(name,myBroadcasterFollower);
    }
 else     if ("post".equals(action)) {
      String message=request.getParameter("message");
      String callback=request.getParameter("callback");
      if (message == null) {
        logger.severe("Message cannot be null");
        return;
      }
      if (callback == null) {
        callback="alert";
      }
      if (myBroadcasterFollower != null) {
        myBroadcasterFollower.broadcast("<script id='comet_" + counter++ + "'>"+ "window.parent."+ callback+ "("+ message+ ");</script>");
      }
 else {
        throw new RuntimeException("Broadcaster was null");
      }
      response.getWriter().println("ok");
    }
 else     if ("start".equals(action)) {
      String message="{ message : 'Welcome'}";
      response.setContentType("text/html;charset=ISO-8859-1");
      String callback=request.getParameter("callback");
      if (callback == null) {
        callback="alert";
      }
      try {
        atmoResource.setBroadcaster(BroadcasterFactory.getDefault().get());
      }
 catch (      Throwable t) {
        throw new IOException(t);
      }
      myBroadcasterFollower=atmoResource.getBroadcaster();
      atmoResource.suspend();
      session.setAttribute("atmoResource",atmoResource);
      session.setAttribute(sessionId,myBroadcasterFollower);
      response.getWriter().println("<script id='comet_" + counter++ + "'>"+ "window.parent."+ callback+ "("+ message+ ");</script>");
      response.getWriter().println(startingMessage);
      response.getWriter().flush();
    }
 else     if ("following".equals(action)) {
      response.setContentType("text/html");
      String follow=request.getParameter("message");
      String name=(String)session.getAttribute("name");
      if (follow == null) {
        logger.severe("Message cannot be null");
        return;
      }
      if (name == null) {
        logger.severe("Name cannot be null");
        return;
      }
      Broadcaster outsiderBroadcaster=(Broadcaster)atmoResource.getAtmosphereConfig().getServletContext().getAttribute(follow);
      AtmosphereResource r=(AtmosphereResource)session.getAttribute("atmoResource");
      if (outsiderBroadcaster == null) {
        myBroadcasterFollower.broadcast(BEGIN_SCRIPT_TAG + toJsonp("Invalid Twitter user ",follow) + END_SCRIPT_TAG,r);
        return;
      }
      outsiderBroadcaster.addAtmosphereResource(r);
      myBroadcasterFollower.broadcast(BEGIN_SCRIPT_TAG + toJsonp("You are now following ",follow) + END_SCRIPT_TAG,r);
      outsiderBroadcaster.broadcast(BEGIN_SCRIPT_TAG + toJsonp(name," is now following " + follow) + END_SCRIPT_TAG);
    }
  }
}
