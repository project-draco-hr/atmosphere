{
  logger.info("{}: running test: testHeaderBroadcasterCache",getClass().getSimpleName());
  atmoServlet.setBroadcasterCacheClassName(HeaderBroadcasterCache.class.getName());
  final CountDownLatch latch=new CountDownLatch(1);
  long t1=System.currentTimeMillis();
  AsyncHttpClient c=new AsyncHttpClient();
  try {
    c.preparePost(urlTarget).addParameter("message","cacheme").execute().get();
    c.preparePost(urlTarget).addParameter("message","cachememe").execute().get();
    Response r=c.prepareGet(urlTarget + "/subscribeAndResume").addHeader(HeaderBroadcasterCache.HEADER_CACHE,String.valueOf(t1)).execute(new AsyncCompletionHandler<Response>(){
      @Override public Response onCompleted(      Response r) throws Exception {
        try {
          return r;
        }
  finally {
          latch.countDown();
        }
      }
    }
).get();
    try {
      latch.await(20,TimeUnit.SECONDS);
    }
 catch (    InterruptedException e) {
      fail(e.getMessage());
    }
    assertNotNull(r);
    assertEquals(r.getStatusCode(),200);
    assertEquals(r.getResponseBody(),"cacheme\ncachememe\n");
  }
 catch (  Exception e) {
    logger.error("test failed",e);
    fail(e.getMessage());
  }
  c.close();
}
