{
  HttpServletRequest res=(HttpServletRequest)r.getRequest();
  try {
    ContainerResponse cr=(ContainerResponse)res.getAttribute(AtmosphereServlet.CONTAINER_RESPONSE);
    if (cr == null) {
      logger.debug("Retrieving HttpServletRequest {} with ContainerResponse {}",res,cr);
      logger.error("Unexpected state. ContainerResponse cannot be null. The connection hasn't been suspended yet");
      return;
    }
    MediaType m=(MediaType)cr.getHttpHeaders().getFirst(HttpHeaders.CONTENT_TYPE);
    if (e.getMessage() instanceof Response) {
      cr.setResponse((Response)e.getMessage());
      cr.getHttpHeaders().add(HttpHeaders.CONTENT_TYPE,m);
      cr.write();
    }
 else     if (e.getMessage() instanceof List) {
      for (      Object msg : (List<Object>)e.getMessage()) {
        cr.setResponse(Response.ok(msg).build());
        cr.getHttpHeaders().add(HttpHeaders.CONTENT_TYPE,m);
        cr.write();
        cr.getOutputStream().flush();
      }
    }
 else {
      cr.setResponse(Response.ok(e.getMessage()).build());
      cr.getHttpHeaders().add(HttpHeaders.CONTENT_TYPE,m);
      cr.write();
    }
    cr.getOutputStream().flush();
  }
 catch (  Throwable t) {
    onException(t,r);
  }
 finally {
    Boolean resumeOnBroadcast=(Boolean)res.getAttribute(AtmosphereServlet.RESUME_ON_BROADCAST);
    if (resumeOnBroadcast != null && resumeOnBroadcast) {
      String uuid=(String)res.getAttribute(AtmosphereFilter.RESUME_UUID);
      if (uuid != null) {
        if (res.getAttribute(AtmosphereFilter.RESUME_CANDIDATES) != null) {
          ((ConcurrentHashMap<String,AtmosphereResource<?,?>>)res.getAttribute(AtmosphereFilter.RESUME_CANDIDATES)).remove(uuid);
        }
      }
      r.resume();
    }
  }
}
