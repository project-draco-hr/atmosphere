{
  HttpServletRequest request=(HttpServletRequest)r.getRequest();
  ContainerResponse cr=null;
  try {
    cr=(ContainerResponse)request.getAttribute(FrameworkConfig.CONTAINER_RESPONSE);
    boolean isCancelled=r.getAtmosphereResourceEvent().isCancelled();
    if (cr == null || isCancelled) {
      logger.debug("Retrieving HttpServletRequest {} with ContainerResponse {}",request,cr);
      if (!isCancelled) {
        logger.debug("Unexpected state. ContainerResponse cannot be null or already committed. The connection hasn't been suspended yet");
      }
 else {
        logger.debug("ContainerResponse already resumed or cancelled. Ignoring");
      }
      if (DefaultBroadcaster.class.isAssignableFrom(broadcaster.getClass())) {
        DefaultBroadcaster.class.cast(broadcaster).cacheLostMessage(r);
      }
      AsynchronousProcessor.destroyResource(r);
      return;
    }
    String m=cr.getHttpHeaders().getFirst(HttpHeaders.CONTENT_TYPE).toString();
    if (e.getMessage() instanceof Response) {
      cr.setResponse((Response)e.getMessage());
      cr.getHttpHeaders().add(HttpHeaders.CONTENT_TYPE,m);
      cr.write();
      if (!cr.isCommitted()) {
        cr.getOutputStream().flush();
      }
    }
 else     if (e.getMessage() instanceof List) {
      for (      Object msg : (List<Object>)e.getMessage()) {
        cr.setResponse(Response.ok(msg).build());
        cr.getHttpHeaders().add(HttpHeaders.CONTENT_TYPE,m);
        cr.write();
      }
      if (!cr.isCommitted()) {
        cr.getOutputStream().flush();
      }
    }
 else {
      if (e.getMessage() == null) {
        logger.warn("Broadcasted message is null");
      }
      cr.setResponse(Response.ok(e.getMessage()).build());
      cr.getHttpHeaders().add(HttpHeaders.CONTENT_TYPE,m);
      cr.write();
      if (!cr.isCommitted()) {
        cr.getOutputStream().flush();
      }
    }
  }
 catch (  Throwable t) {
    if (DefaultBroadcaster.class.isAssignableFrom(broadcaster.getClass())) {
      DefaultBroadcaster.class.cast(broadcaster).onException(t,r);
    }
 else {
      onException(t,r);
    }
  }
 finally {
    if (cr != null) {
      cr.setEntity(null);
    }
    e.setMessage(null);
    Boolean resumeOnBroadcast=(Boolean)request.getAttribute(ApplicationConfig.RESUME_ON_BROADCAST);
    if (resumeOnBroadcast != null && resumeOnBroadcast) {
      String uuid=(String)request.getAttribute(AtmosphereFilter.RESUME_UUID);
      if (uuid != null) {
        if (request.getAttribute(AtmosphereFilter.RESUME_CANDIDATES) != null) {
          ((ConcurrentHashMap<String,AtmosphereResource<?,?>>)request.getAttribute(AtmosphereFilter.RESUME_CANDIDATES)).remove(uuid);
        }
      }
      r.resume();
    }
  }
}
