{
  logger.info("Running testBroadcasterScope");
  final CountDownLatch latch=new CountDownLatch(1);
  final CountDownLatch latch2=new CountDownLatch(1);
  servletLatch=new CountDownLatch(1);
  AsyncHttpClient c=new AsyncHttpClient();
  Broadcaster b=null;
  try {
    long currentTime=System.currentTimeMillis();
    final AtomicReference<Response> r=new AtomicReference();
    c.prepareGet(urlTarget).execute(new AsyncCompletionHandler<Response>(){
      @Override public Response onCompleted(      Response response) throws Exception {
        r.set(response);
        latch.countDown();
        return response;
      }
    }
);
    servletLatch.await();
    String id=broadcasterId.get();
    b=BroadcasterFactory.getDefault().lookup(DefaultBroadcaster.class,id);
    assertNotNull(b);
    b.broadcast("resume").get();
    try {
      latch.await();
    }
 catch (    InterruptedException e) {
      fail(e.getMessage());
      return;
    }
    long time=System.currentTimeMillis() - currentTime;
    if (time < 5000) {
      assertTrue(true);
    }
 else {
      assertFalse(false);
    }
    assertNotNull(r.get());
    assertEquals(r.get().getStatusCode(),200);
    String resume=r.get().getResponseBody();
    assertEquals(resume,"resumeresume");
    c.prepareGet(urlTarget).execute(new AsyncCompletionHandler<Response>(){
      @Override public Response onCompleted(      Response response) throws Exception {
        r.set(response);
        latch2.countDown();
        return response;
      }
    }
);
    try {
      latch2.await();
    }
 catch (    InterruptedException e) {
      fail(e.getMessage());
      return;
    }
    assertFalse(id.equals(broadcasterId.get()));
  }
 catch (  Exception e) {
    logger.error("test failed",e);
    fail(e.getMessage());
  }
 finally {
    if (b != null)     b.destroy();
  }
  c.close();
}
