{
  Object message=event.getMessage();
  AtmosphereResponse r=event.getResource().getResponse();
  if (message == null || event.isCancelled() || event.isResuming() || event.getResource().getRequest().destroyed())   return;
  if (event.getResource().getSerializer() != null) {
    try {
      event.getResource().getSerializer().write(event.getResource().getResponse().getOutputStream(),message);
    }
 catch (    Throwable ex) {
      logger.warn("Serializer exception: message: " + message,ex);
      throw new IOException(ex);
    }
  }
 else {
    boolean isUsingStream=(Boolean)event.getResource().getRequest().getAttribute(PROPERTY_USE_STREAM);
    if (!isUsingStream) {
      try {
        r.getWriter();
      }
 catch (      IllegalStateException e) {
        isUsingStream=true;
      }
    }
    if (message instanceof List) {
      for (      String s : (List<String>)message) {
        if (isUsingStream) {
          r.getOutputStream().write(s.getBytes(r.getCharacterEncoding()));
          r.getOutputStream().flush();
        }
 else {
          r.getWriter().write(s);
          r.getWriter().flush();
        }
      }
    }
 else {
      if (isUsingStream) {
        r.getOutputStream().write(message.toString().getBytes(r.getCharacterEncoding()));
        r.getOutputStream().flush();
      }
 else {
        r.getWriter().write(message.toString());
        r.getWriter().flush();
      }
    }
    postStateChange(event);
  }
}
