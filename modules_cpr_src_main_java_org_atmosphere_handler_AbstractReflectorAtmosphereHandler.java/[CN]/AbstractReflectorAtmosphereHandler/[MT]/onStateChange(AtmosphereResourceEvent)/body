{
  Object message=event.getMessage();
  if (message == null || event.isCancelled() || event.getResource().getRequest().destroyed())   return;
  if (event.getResource().getSerializer() != null) {
    try {
      event.getResource().getSerializer().write(event.getResource().getResponse().getOutputStream(),message);
    }
 catch (    Throwable ex) {
      logger.warn("Serializer exception: message: " + message,ex);
      throw new IOException(ex);
    }
  }
 else {
    boolean isUsingStream=(Boolean)event.getResource().getRequest().getAttribute(PROPERTY_USE_STREAM);
    if (!isUsingStream) {
      try {
        event.getResource().getResponse().getWriter();
      }
 catch (      IllegalStateException e) {
        isUsingStream=true;
      }
    }
    if (message instanceof List) {
      for (      String s : (List<String>)message) {
        if (isUsingStream) {
          event.getResource().getResponse().getOutputStream().write(s.getBytes("UTF-8"));
          event.getResource().getResponse().getOutputStream().flush();
        }
 else {
          event.getResource().getResponse().getWriter().write(s);
          event.getResource().getResponse().getWriter().flush();
        }
      }
    }
 else {
      if (isUsingStream) {
        event.getResource().getResponse().getOutputStream().write(message.toString().getBytes("UTF-8"));
        event.getResource().getResponse().getOutputStream().flush();
      }
 else {
        event.getResource().getResponse().getWriter().write(message.toString());
        event.getResource().getResponse().getWriter().flush();
      }
    }
    Boolean resumeOnBroadcast=event.getResource().resumeOnBroadcast();
    if (!resumeOnBroadcast) {
      Object o=event.getResource().getRequest().getAttribute(ApplicationConfig.RESUME_ON_BROADCAST);
      if (o != null && Boolean.class.isAssignableFrom(o.getClass())) {
        resumeOnBroadcast=Boolean.class.cast(o);
      }
    }
    if (resumeOnBroadcast != null && resumeOnBroadcast) {
      event.getResource().resume();
    }
  }
}
