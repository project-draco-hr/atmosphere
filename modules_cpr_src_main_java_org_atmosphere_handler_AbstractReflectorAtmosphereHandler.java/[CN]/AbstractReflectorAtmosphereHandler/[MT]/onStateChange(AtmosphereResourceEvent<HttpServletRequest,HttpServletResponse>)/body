{
  Object message=event.getMessage();
  if (message == null || event.isCancelled())   return;
  if (event.getResource().getSerializer() != null) {
    try {
      event.getResource().getSerializer().write(event.getResource().getResponse().getOutputStream(),message);
    }
 catch (    Throwable ex) {
      logger.warn("Serializer exception: message: " + message,ex);
      throw new IOException(ex);
    }
  }
 else {
    boolean isUsingStream=false;
    try {
      event.getResource().getResponse().getWriter();
    }
 catch (    IllegalStateException e) {
      isUsingStream=true;
    }
    if (message instanceof List) {
      for (      String s : (List<String>)message) {
        if (isUsingStream) {
          event.getResource().getResponse().getOutputStream().write(s.getBytes());
          event.getResource().getResponse().getOutputStream().flush();
        }
 else {
          event.getResource().getResponse().getWriter().write(s);
          event.getResource().getResponse().getWriter().flush();
        }
      }
    }
 else {
      if (isUsingStream) {
        event.getResource().getResponse().getOutputStream().write(message.toString().getBytes());
        event.getResource().getResponse().getOutputStream().flush();
      }
 else {
        event.getResource().getResponse().getWriter().write(message.toString());
        event.getResource().getResponse().getWriter().flush();
      }
    }
    Boolean resumeOnBroadcast=(Boolean)event.getResource().getRequest().getAttribute(AtmosphereServlet.RESUME_ON_BROADCAST);
    if (resumeOnBroadcast != null && resumeOnBroadcast) {
      event.getResource().resume();
    }
  }
}
