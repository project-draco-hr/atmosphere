{
  System.setProperty("org.atmosphere.useNative","true");
  int port=TestHelper.getEnvVariable("ATMOSPHERE_HTTP_PORT",9999);
  urlTarget="http://127.0.0.1:" + port + "/invoke";
  atmoServlet=new AtmosphereServlet();
  atmoServlet.addInitParameter(CometSupport.MAX_INACTIVE,"20000");
  embedded=new Embedded();
  String path=new File(".").getAbsolutePath();
  embedded.setCatalinaHome(path);
  Engine engine=embedded.createEngine();
  engine.setDefaultHost("127.0.0.1");
  Host host=embedded.createHost("127.0.0.1",path);
  engine.addChild(host);
  Context c=embedded.createContext("/",path);
  c.setReloadable(false);
  Wrapper w=c.createWrapper();
  w.addMapping("/*");
  w.setServletClass(TomcatAtmosphereServlet.class.getName());
  w.setLoadOnStartup(0);
  w.addInitParameter(CometSupport.MAX_INACTIVE,"20000");
  c.addChild(w);
  host.addChild(c);
  Connector connector=embedded.createConnector("127.0.0.1",port,Http11NioProtocol.class.getName());
  connector.setContainer(host);
  embedded.addEngine(engine);
  embedded.addConnector(connector);
  embedded.start();
  atmoServlet=(AtmosphereServlet)w.getServlet();
}
