{
  final ClassLoader cl=Thread.currentThread().getContextClassLoader();
  final AnnotationDetector.TypeReporter reporter=new AnnotationDetector.TypeReporter(){
    @SuppressWarnings("unchecked") @Override public Class<? extends Annotation>[] annotations(){
      return new Class[]{AtmosphereHandlerService.class,BroadcasterCacheService.class,BroadcasterFilterService.class,BroadcasterService.class,MeteorService.class,WebSocketHandlerService.class,WebSocketProtocolService.class,WebSocketResponseFilterService.class};
    }
    @Override public void reportTypeAnnotation(    Class<? extends Annotation> annotation,    String className){
      logger.info("Annotation in {} being scanned: {}",className,annotation);
      if (AtmosphereHandlerService.class.equals(annotation)) {
        try {
          AtmosphereHandler handler=(AtmosphereHandler)cl.loadClass(className).newInstance();
          AtmosphereHandlerService a=handler.getClass().getAnnotation(AtmosphereHandlerService.class);
          framework.addAtmosphereHandler(a.path(),handler);
          framework.setDefaultBroadcasterClassName(a.broadcasterClassName());
          for (          String s : a.properties()) {
            String[] nv=s.split(",");
            IntrospectionUtils.setProperty(handler,nv[0],nv[1]);
            IntrospectionUtils.addProperty(handler,nv[0],nv[1]);
          }
          for (          String s : a.atmosphereConfig()) {
            String[] nv=s.split(",");
            framework.addInitParameter(nv[0],nv[1]);
          }
        }
 catch (        Throwable e) {
          logger.warn("",e);
        }
      }
 else       if (BroadcasterCacheService.class.equals(annotation)) {
        framework.setBroadcasterCacheClassName(className);
      }
 else       if (MeteorService.class.equals(annotation)) {
        try {
          ReflectorServletProcessor r=new ReflectorServletProcessor();
          r.setServletClassName(className);
          Class<Servlet> s=(Class<Servlet>)cl.loadClass(className);
          String mapping=s.getAnnotation(MeteorService.class).value();
          framework.addAtmosphereHandler(mapping,r);
        }
 catch (        Throwable e) {
          logger.warn("",e);
        }
      }
 else       if (BroadcasterFilterService.class.equals(annotation)) {
        framework.broadcasterFilters().add(className);
      }
 else       if (BroadcasterService.class.equals(annotation)) {
        framework.setDefaultBroadcasterClassName(className);
      }
 else       if (WebSocketHandlerService.class.equals(annotation)) {
        framework.setWebSocketProtocolClassName(className);
      }
 else       if (WebSocketProtocolService.class.equals(annotation)) {
        framework.setWebSocketProtocolClassName(className);
      }
 else       if (WebSocketResponseFilterService.class.equals(annotation)) {
      }
    }
  }
;
  logger.info("Scanning @Service annotations in {}",rootDir.getAbsolutePath());
  final AnnotationDetector cf=new AnnotationDetector(reporter);
  cf.detect(rootDir);
  return this;
}
