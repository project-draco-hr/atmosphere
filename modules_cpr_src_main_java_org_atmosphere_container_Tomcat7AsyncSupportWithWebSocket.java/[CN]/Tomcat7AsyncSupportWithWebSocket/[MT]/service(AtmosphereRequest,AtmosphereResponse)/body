{
  if (req.getAttribute(WebSocket.WEBSOCKET_SUSPEND) == null) {
    String key;
    String subProtocol=null;
    if (!headerContainsToken(req,"upgrade","websocket")) {
      return super.service(req,res);
    }
    if (!headerContainsToken(req,"connection","upgrade")) {
      return super.service(req,res);
    }
    if (!headerContainsToken(req,"sec-websocket-version","13")) {
      logger.debug("WebSocket version not supported. Downgrading to Comet");
      res.sendError(202,"Websocket protocol not supported");
      return new AtmosphereFramework.Action(AtmosphereFramework.Action.TYPE.CANCELLED);
    }
    key=req.getHeader("Sec-WebSocket-Key");
    if (key == null) {
      return super.service(req,res);
    }
    res.setHeader("upgrade","websocket");
    res.setHeader("connection","upgrade");
    res.setHeader("Sec-WebSocket-Accept",getWebSocketAccept(key));
    if (subProtocol != null) {
      res.setHeader("Sec-WebSocket-Protocol",subProtocol);
    }
    RequestFacade facade=(RequestFacade)req.wrappedRequest();
    StreamInbound inbound=new TomcatWebSocketHandler(AtmosphereRequest.loadInMemory(req,true),config.framework(),config.framework().getWebSocketProtocol());
    facade.doUpgrade(inbound);
  }
  AtmosphereFramework.Action action=suspended(req,res);
  if (action.type == AtmosphereFramework.Action.TYPE.SUSPEND) {
    logger.debug("Suspending resonse: {}",res);
  }
 else   if (action.type == AtmosphereFramework.Action.TYPE.RESUME) {
    logger.debug("Resume resonse: {}",res);
    req.setAttribute(WebSocket.WEBSOCKET_RESUME,true);
  }
  return action;
}
