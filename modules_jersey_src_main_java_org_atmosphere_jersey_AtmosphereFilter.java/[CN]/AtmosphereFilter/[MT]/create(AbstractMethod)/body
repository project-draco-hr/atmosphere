{
  LinkedList<ResourceFilter> list=new LinkedList<ResourceFilter>();
  Filter f;
  if (logger.isLoggable(Level.FINE)) {
    for (    Annotation a : am.getAnnotations()) {
      logger.log(Level.FINE,"AtmosphereFilter processing annotation: " + a);
    }
  }
  if (SuspendResponse.class.isAssignableFrom(am.getMethod().getReturnType())) {
    list.addLast(new Filter(Action.SUSPEND_RESPONSE));
    return list;
  }
  if (am.isAnnotationPresent(Broadcast.class)) {
    int delay=am.getAnnotation(Broadcast.class).delay();
    Class[] suspendTimeout=am.getAnnotation(Broadcast.class).value();
    if (am.getAnnotation(Broadcast.class).resumeOnBroadcast()) {
      f=new Filter(Action.RESUME_ON_BROADCAST,delay,0,Suspend.SCOPE.APPLICATION,true,suspendTimeout);
    }
 else {
      f=new Filter(Action.BROADCAST,delay,0,Suspend.SCOPE.APPLICATION,true,suspendTimeout);
    }
    list.addLast((ResourceFilter)f);
    if (am.isAnnotationPresent(Cluster.class)) {
      suspendTimeout=am.getAnnotation(Cluster.class).value();
      for (      Class<ClusterBroadcastFilter> c : suspendTimeout) {
        try {
          ClusterBroadcastFilter cbf=c.newInstance();
          InjectorProvider.getInjector().inject(cbf);
          cbf.setUri(am.getAnnotation(Cluster.class).name());
          f.addCluster(cbf);
        }
 catch (        Throwable t) {
          logger.log(Level.WARNING,"Invalid ClusterBroadcastFilter",t);
        }
      }
    }
  }
  if (am.isAnnotationPresent(Suspend.class)) {
    long suspendTimeout=am.getAnnotation(Suspend.class).period();
    TimeUnit tu=am.getAnnotation(Suspend.class).timeUnit();
    suspendTimeout=translateTimeUnit(suspendTimeout,tu);
    Suspend.SCOPE scope=am.getAnnotation(Suspend.class).scope();
    boolean outputComments=am.getAnnotation(Suspend.class).outputComments();
    if (am.getAnnotation(Suspend.class).resumeOnBroadcast()) {
      f=new Filter(Action.SUSPEND_RESUME,suspendTimeout,0,scope,outputComments);
    }
 else {
      f=new Filter(Action.SUSPEND,suspendTimeout,0,scope,outputComments);
    }
    f.setListeners(am.getAnnotation(Suspend.class).listeners());
    list.addFirst((ResourceFilter)f);
  }
  if (am.isAnnotationPresent(Resume.class)) {
    int suspendTimeout=am.getAnnotation(Resume.class).value();
    list.addFirst((ResourceFilter)new Filter(Action.RESUME,suspendTimeout));
  }
  if (am.isAnnotationPresent(Schedule.class)) {
    int period=am.getAnnotation(Schedule.class).period();
    int waitFor=am.getAnnotation(Schedule.class).waitFor();
    if (am.getAnnotation(Schedule.class).resumeOnBroadcast()) {
      list.addFirst((ResourceFilter)new Filter(Action.SCHEDULE_RESUME,period,waitFor));
    }
 else {
      list.addFirst((ResourceFilter)new Filter(Action.SCHEDULE,period,waitFor));
    }
  }
  return list.size() > 0 ? list : null;
}
