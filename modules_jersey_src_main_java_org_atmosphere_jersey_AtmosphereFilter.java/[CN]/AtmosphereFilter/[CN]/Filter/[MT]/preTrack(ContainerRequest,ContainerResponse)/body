{
  TrackableResource<? extends Trackable> trackableResource=TrackableResource.class.cast(response.getEntity());
  if (trackableResource == null) {
    trackableResource=new TrackableResource<AtmosphereResource>(AtmosphereResource.class,servletReq.getHeader(X_ATMOSPHERE_TRACKING_ID),"");
  }
 else {
    response.setEntity(trackableResource.entity());
  }
  String trackableUUID=request.getHeaderValue(X_ATMOSPHERE_TRACKING_ID);
  if (trackableUUID == null && trackableResource.trackingID() != null) {
    trackableUUID=trackableResource.trackingID();
  }
 else   if (trackableUUID == null) {
    trackableUUID=UUID.randomUUID().toString();
  }
  trackableResource.setTrackingID(trackableUUID);
  TrackableSession.getDefault().track(trackableResource);
  response.getHttpHeaders().putSingle(X_ATMOSPHERE_TRACKING_ID,trackableResource.trackingID());
  servletReq.setAttribute(X_ATMOSPHERE_TRACKING_ID,trackableResource.trackingID());
  return trackableResource;
}
