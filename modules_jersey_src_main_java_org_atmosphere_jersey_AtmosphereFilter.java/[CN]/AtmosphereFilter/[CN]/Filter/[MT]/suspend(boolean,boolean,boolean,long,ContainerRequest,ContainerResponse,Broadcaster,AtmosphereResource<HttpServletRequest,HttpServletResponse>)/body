{
  if (response.getStatus() == 204) {
    response.setStatus(200);
  }
  BroadcasterFactory broadcasterFactory=(BroadcasterFactory)servletReq.getAttribute(AtmosphereServlet.BROADCASTER_FACTORY);
  if (!sessionSupported && !resumeOnBroadcast && response.getHttpHeaders().getFirst("Location") == null) {
    String uuid=UUID.randomUUID().toString();
    response.getHttpHeaders().putSingle(HttpHeaders.LOCATION,uriInfo.getAbsolutePathBuilder().path(uuid).build(""));
    resumeCandidates.put(uuid,r);
    servletReq.setAttribute(RESUME_UUID,uuid);
    servletReq.setAttribute(RESUME_CANDIDATES,resumeCandidates);
  }
  if (bc == null) {
    bc=r.getBroadcaster();
  }
  if (sessionSupported && servletReq.getSession().getAttribute(SUSPENDED_RESOURCE) != null) {
    AtmosphereResource<HttpServletRequest,HttpServletResponse> cached=(AtmosphereResource)servletReq.getSession().getAttribute(SUSPENDED_RESOURCE);
    bc=cached.getBroadcaster();
    try {
      bc.removeAtmosphereResource(cached);
    }
 catch (    IllegalStateException ex) {
      logger.trace(ex.getMessage(),ex);
    }
  }
  if (response.getEntity() instanceof Broadcastable) {
    Broadcastable b=(Broadcastable)response.getEntity();
    bc=b.getBroadcaster();
    response.setEntity(b.getResponseMessage());
    if ((scope == Suspend.SCOPE.REQUEST) && (bc.getScope() != Broadcaster.SCOPE.REQUEST)) {
      bc.setScope(Broadcaster.SCOPE.REQUEST);
    }
  }
 else   if ((scope == Suspend.SCOPE.REQUEST) && (bc.getScope() != Broadcaster.SCOPE.REQUEST)) {
    try {
      String id=bc.getID();
      bc.setID(bc.getClass().getSimpleName() + "-" + UUID.randomUUID());
      bc=broadcasterFactory.get();
      bc.setScope(Broadcaster.SCOPE.REQUEST);
      bc.setID(id);
    }
 catch (    Exception ex) {
      logger.error("failed to instantiate broadcaster with factory: " + broadcasterFactory,ex);
    }
  }
  configureFilter(bc);
  r.setBroadcaster(bc);
  if (sessionSupported) {
    servletReq.getSession().setAttribute(SUSPENDED_RESOURCE,r);
    servletReq.getSession().setAttribute(AtmosphereServlet.CONTAINER_RESPONSE,response);
  }
  servletReq.setAttribute(SUSPENDED_RESOURCE,r);
  servletReq.setAttribute(AtmosphereServlet.CONTAINER_RESPONSE,response);
  logger.debug("Linking HttpServletRequest {} with ContainerResponse {}",servletReq,response);
  if (resumeOnBroadcast) {
    servletReq.setAttribute(AtmosphereServlet.RESUME_ON_BROADCAST,new Boolean(true));
  }
  try {
    MediaType contentType=response.getMediaType();
    if (contentType == null && response.getEntity() != null) {
      LinkedList<MediaType> l=new LinkedList<MediaType>();
      l.add(request.getAcceptableMediaType(new LinkedList<MediaType>()));
      contentType=response.getMessageBodyWorkers().getMessageBodyWriterMediaType(response.getEntity().getClass(),response.getEntityType(),response.getAnnotations(),l);
      if (contentType == null || contentType.isWildcardType() || contentType.isWildcardSubtype())       contentType=MediaType.APPLICATION_OCTET_STREAM_TYPE;
    }
    Object entity=response.getEntity();
    if (entity != null) {
      r.getResponse().setContentType(contentType != null ? contentType.toString() : "text/html; charset=ISO-8859-1");
    }
    configureHeaders(response);
    if (comments && !resumeOnBroadcast) {
      response.setEntity(AtmosphereResourceImpl.createCompatibleStringJunk());
    }
    if (entity != null) {
      response.setEntity(entity);
      response.write();
    }
    r.suspend(timeout,false);
  }
 catch (  IOException ex) {
    throw new WebApplicationException(ex);
  }
}
