{
  boolean webSocketSupported=servletReq.getAttribute(WebSocketSupport.WEBSOCKET_SUSPEND) != null;
  if (servletReq.getHeaders("Connection") != null && servletReq.getHeaders("Connection").hasMoreElements()) {
    String[] e=((Enumeration<String>)servletReq.getHeaders("Connection")).nextElement().split(",");
    for (    String upgrade : e) {
      if (upgrade != null && upgrade.equalsIgnoreCase("Upgrade")) {
        if (!webSocketSupported) {
          response.getHttpHeaders().putSingle("X-Atmosphere-error","Websocket protocol not supported");
        }
      }
    }
  }
  boolean injectCacheHeaders=(Boolean)servletReq.getAttribute(AtmosphereServlet.NO_CACHE_HEADERS);
  boolean enableAccessControl=(Boolean)servletReq.getAttribute(AtmosphereServlet.DROP_ACCESS_CONTROL_ALLOW_ORIGIN_HEADER);
  if (injectCacheHeaders) {
    response.getHttpHeaders().putSingle("Expires","-1");
    response.getHttpHeaders().putSingle("Cache-Control","no-store, no-cache, must-revalidate");
    response.getHttpHeaders().putSingle("Pragma","no-cache");
  }
  if (enableAccessControl) {
    response.getHttpHeaders().putSingle("Access-Control-Allow-Origin","*");
    response.getHttpHeaders().putSingle("Access-Control-Allow-Credentials","true");
  }
}
