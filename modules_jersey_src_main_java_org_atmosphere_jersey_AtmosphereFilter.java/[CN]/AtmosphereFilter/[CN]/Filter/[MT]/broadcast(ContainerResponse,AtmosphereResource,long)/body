{
  Object o=r.getEntity();
  Broadcaster b=ar.getBroadcaster();
  Object msg=o;
  String returnMsg=null;
  if (o instanceof Broadcastable) {
    if (((Broadcastable)o).getBroadcaster() != null) {
      b=((Broadcastable)o).getBroadcaster();
    }
    msg=((Broadcastable)o).getMessage();
    returnMsg=((Broadcastable)o).getResponseMessage().toString();
  }
  if (action == Action.RESUME_ON_BROADCAST) {
    configureResumeOnBroadcast(b);
  }
  if (o != null) {
    addFilter(b);
    try {
      r.setEntity(msg);
      if (msg == null)       return;
      if (delay == -1) {
        Object t=b.broadcast(msg).get();
        if (o instanceof Broadcastable) {
          r.setEntity(returnMsg);
        }
      }
 else       if (delay == 0) {
        b.delayBroadcast(msg);
      }
 else {
        b.delayBroadcast(msg,delay,TimeUnit.SECONDS);
      }
    }
 catch (    InterruptedException ex) {
      logger.error("broadcast interrupted",ex);
    }
catch (    ExecutionException ex) {
      logger.error("execution exception during broadcast",ex);
    }
  }
}
