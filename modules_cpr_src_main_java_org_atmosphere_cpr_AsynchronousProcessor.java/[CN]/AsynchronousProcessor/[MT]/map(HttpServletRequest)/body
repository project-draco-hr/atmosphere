{
  String path=req.getRequestURI();
  if (path == null || path.length() == 0) {
    path="/*";
  }
  AtmosphereHandlerWrapper atmosphereHandlerWrapper=config.handlers().get(path);
  if (atmosphereHandlerWrapper == null) {
    final Map<String,String> m=new HashMap<String,String>();
    for (    Map.Entry<String,AtmosphereHandlerWrapper> e : config.handlers().entrySet()) {
      UriTemplate t=new UriTemplate(e.getKey());
      logger.trace("Trying to map {} to {}",t,path);
      if (t.match(path,m)) {
        atmosphereHandlerWrapper=e.getValue();
        logger.trace("Mapped {} to {}",t,e.getValue());
        break;
      }
    }
  }
  if (atmosphereHandlerWrapper == null) {
    throw new ServletException("No AtmosphereHandler maps request for " + path);
  }
  config.getBroadcasterFactory().add(atmosphereHandlerWrapper.broadcaster,atmosphereHandlerWrapper.broadcaster.getID());
  return atmosphereHandlerWrapper;
}
