{
  String path;
  if (req.getPathInfo() != null) {
    path=req.getServletPath() + req.getPathInfo();
  }
 else {
    path=req.getServletPath();
  }
  if (path.isEmpty()) {
    path="/";
  }
  AtmosphereHandlerWrapper atmosphereHandlerWrapper=map(path);
  if (atmosphereHandlerWrapper == null) {
    if (!path.endsWith("/")) {
      atmosphereHandlerWrapper=map(path + "/");
    }
    if (atmosphereHandlerWrapper == null) {
      atmosphereHandlerWrapper=map("/all");
    }
  }
  if (atmosphereHandlerWrapper == null) {
    throw new AtmosphereMappingException("No AtmosphereHandler maps request for " + path);
  }
  config.getBroadcasterFactory().add(atmosphereHandlerWrapper.broadcaster,atmosphereHandlerWrapper.broadcaster.getID());
  return atmosphereHandlerWrapper;
}
