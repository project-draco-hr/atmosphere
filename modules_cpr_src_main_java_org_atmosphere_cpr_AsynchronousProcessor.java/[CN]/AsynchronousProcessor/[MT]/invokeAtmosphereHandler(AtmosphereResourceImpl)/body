{
  HttpServletRequest req=r.getRequest();
  HttpServletResponse response=r.getResponse();
  String disableOnEvent=r.getAtmosphereConfig().getInitParameter(ApplicationConfig.DISABLE_ONSTATE_EVENT);
  try {
    if (!r.getResponse().equals(response)) {
      logger.warn("Invalid response: {}",response);
    }
 else     if (disableOnEvent == null || !disableOnEvent.equals(String.valueOf(true))) {
      AtmosphereHandler<HttpServletRequest,HttpServletResponse> atmosphereHandler=(AtmosphereHandler<HttpServletRequest,HttpServletResponse>)req.getAttribute(FrameworkConfig.ATMOSPHERE_HANDLER);
synchronized (r) {
        atmosphereHandler.onStateChange(r.getAtmosphereResourceEvent());
        r.setIsInScope(false);
        Meteor m=(Meteor)req.getAttribute(AtmosphereResourceImpl.METEOR);
        if (m != null) {
          m.destroy();
        }
      }
    }
 else {
      r.getResponse().flushBuffer();
    }
  }
 catch (  IOException ex) {
    try {
      r.onThrowable(ex);
    }
 catch (    Throwable t) {
      logger.warn("failed calling onThrowable()",ex);
    }
  }
 finally {
    try {
      aliveRequests.remove(req);
      r.notifyListeners();
    }
  finally {
      destroyResource(r);
    }
  }
}
