{
  HttpServletRequest req=r.getRequest();
  HttpServletResponse response=r.getResponse();
  String disableOnEvent=r.getAtmosphereConfig().getInitParameter(AtmosphereServlet.DISABLE_ONSTATE_EVENT);
  try {
    if (!r.getResponse().equals(response)) {
      logger.warn("Invalid response: {}",response);
    }
 else     if (disableOnEvent == null || !disableOnEvent.equals(String.valueOf(true))) {
      AtmosphereHandler<HttpServletRequest,HttpServletResponse> atmosphereHandler=(AtmosphereHandler<HttpServletRequest,HttpServletResponse>)req.getAttribute(AtmosphereServlet.ATMOSPHERE_HANDLER);
      atmosphereHandler.onStateChange(r.getAtmosphereResourceEvent());
    }
 else {
      r.getResponse().flushBuffer();
    }
  }
 catch (  IOException ex) {
    try {
      r.onThrowable(ex);
    }
 catch (    Throwable t) {
      logger.warn("failed calling onThrowable()",ex);
    }
  }
 finally {
    try {
      aliveRequests.remove(req);
      r.notifyListeners();
    }
  finally {
      r.removeEventListeners();
      r.getBroadcaster().removeAtmosphereResource(r);
    }
  }
}
