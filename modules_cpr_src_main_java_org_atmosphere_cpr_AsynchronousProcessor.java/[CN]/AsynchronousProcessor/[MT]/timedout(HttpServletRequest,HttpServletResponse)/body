{
  AtmosphereResourceImpl r;
  long l=(Long)request.getAttribute(MAX_INACTIVE);
  if (l == -1) {
    return timedoutAction;
  }
  request.setAttribute(MAX_INACTIVE,(long)-1);
  logger.debug("Timing out the connection for request {}",request);
  if (request == null || response == null) {
    logger.warn("Invalid Request/Response: {}/{}",request,response);
    return timedoutAction;
  }
  r=(AtmosphereResourceImpl)request.getAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
  if (r != null && r.getAtmosphereResourceEvent().isSuspended()) {
    r.getAtmosphereResourceEvent().setIsResumedOnTimeout(true);
    Broadcaster b=r.getBroadcaster();
    if (b instanceof DefaultBroadcaster) {
      ((DefaultBroadcaster)b).broadcastOnResume(r);
    }
    if (r.getRequest().getAttribute(ApplicationConfig.RESUMED_ON_TIMEOUT) != null) {
      r.getAtmosphereResourceEvent().setIsResumedOnTimeout((Boolean)r.getRequest().getAttribute(ApplicationConfig.RESUMED_ON_TIMEOUT));
    }
    invokeAtmosphereHandler(r);
    try {
      r.getResponse().getOutputStream().close();
    }
 catch (    Throwable t) {
      try {
        r.getResponse().getWriter().close();
      }
 catch (      Throwable t2) {
      }
    }
  }
  return timedoutAction;
}
