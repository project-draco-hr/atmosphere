{
  AtmosphereResourceImpl re;
  long l=(Long)req.getAttribute(MAX_INACTIVE);
  if (l == -1) {
    return timedoutAction;
  }
  req.setAttribute(MAX_INACTIVE,(long)-1);
  if (req == null || res == null) {
    logger.warning("Invalid Request/Response: " + req + "/"+ res);
    return timedoutAction;
  }
  re=(AtmosphereResourceImpl)req.getAttribute(AtmosphereServlet.ATMOSPHERE_RESOURCE);
  if (re != null) {
    re.getAtmosphereResourceEvent().isResumedOnTimeout=true;
    Broadcaster b=re.getBroadcaster();
    if (b instanceof DefaultBroadcaster) {
      ((DefaultBroadcaster)b).broadcastOnResume();
    }
    if (re.getRequest().getAttribute(AtmosphereServlet.RESUMED_ON_TIMEOUT) != null) {
      re.getAtmosphereResourceEvent().isResumedOnTimeout=(Boolean)re.getRequest().getAttribute(AtmosphereServlet.RESUMED_ON_TIMEOUT);
    }
    invokeAtmosphereHandler(re);
  }
  return timedoutAction;
}
