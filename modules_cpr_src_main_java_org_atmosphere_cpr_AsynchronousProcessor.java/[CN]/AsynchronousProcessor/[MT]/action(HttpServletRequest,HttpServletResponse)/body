{
  boolean webSocketEnabled=false;
  if (req.getHeaders("Connection") != null && req.getHeaders("Connection").hasMoreElements()) {
    String[] e=req.getHeaders("Connection").nextElement().split(",");
    for (    String upgrade : e) {
      if (upgrade.equalsIgnoreCase("Upgrade")) {
        webSocketEnabled=true;
        break;
      }
    }
  }
  if (webSocketEnabled && !supportWebSocket()) {
    res.setStatus(501);
    res.addHeader(X_ATMOSPHERE_ERROR,"Websocket protocol not supported");
    res.flushBuffer();
    return new Action();
  }
  if (config.handlers().isEmpty()) {
    logger.error("No AtmosphereHandler found. Make sure you define it inside META-INF/atmosphere.xml");
    throw new ServletException("No AtmosphereHandler found. Make sure you define it inside META-INF/atmosphere.xml");
  }
  if (supportSession()) {
    HttpSession session=req.getSession(true);
    if (session.getMaxInactiveInterval() == DEFAULT_SESSION_TIMEOUT) {
      session.setMaxInactiveInterval(-1);
    }
  }
  req.setAttribute(FrameworkConfig.SUPPORT_SESSION,supportSession());
  AtmosphereHandlerWrapper handlerWrapper=map(req);
  AtmosphereResourceImpl resource=new AtmosphereResourceImpl(config,handlerWrapper.broadcaster,req,res,this,handlerWrapper.atmosphereHandler);
  req.setAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE,resource);
  req.setAttribute(FrameworkConfig.ATMOSPHERE_HANDLER,handlerWrapper.atmosphereHandler);
  try {
    handlerWrapper.atmosphereHandler.onRequest(resource);
  }
 catch (  IOException t) {
    resource.onThrowable(t);
    throw t;
  }
  if (resource.getAtmosphereResourceEvent().isSuspended()) {
    req.setAttribute(MAX_INACTIVE,System.currentTimeMillis());
    aliveRequests.put(req,resource);
  }
  return resource.action();
}
