{
  String upgrade=req.getHeader("Connection");
  if (upgrade != null && upgrade.equalsIgnoreCase("Upgrade") && !supportWebSocket()) {
    res.setStatus(501);
    res.addHeader("X-Atmosphere-error","Websocket protocol not supported");
    res.flushBuffer();
    return new Action();
  }
  if (config.handlers().size() == 0) {
    logger.log(Level.SEVERE,"No AtmosphereHandler found. Make sure you define it inside META-INF/atmosphere.xml");
    throw new ServletException("No AtmosphereHandler found. Make sure you define it inside META-INF/atmosphere.xml");
  }
  if (supportSession()) {
    HttpSession session=req.getSession(true);
    if (session.getMaxInactiveInterval() == DEFAULT_SESSION_TIMEOUT) {
      session.setMaxInactiveInterval(-1);
    }
  }
  req.setAttribute(AtmosphereServlet.SUPPORT_SESSION,supportSession());
  AtmosphereHandlerWrapper g=map(req);
  AtmosphereResourceImpl re=new AtmosphereResourceImpl(config,g.broadcaster,req,res,this);
  req.setAttribute(AtmosphereServlet.ATMOSPHERE_RESOURCE,re);
  req.setAttribute(AtmosphereServlet.ATMOSPHERE_HANDLER,g.atmosphereHandler);
  try {
    g.atmosphereHandler.onRequest(re);
  }
 catch (  IOException t) {
    re.notifyListeners(t);
    throw t;
  }
  config.mapBroadcasterToAtmosphereHandler(re.getBroadcaster(),g);
  if (re.getAtmosphereResourceEvent().isSuspended()) {
    req.setAttribute(MAX_INACTIVE,System.currentTimeMillis());
    aliveRequests.put(req,re);
  }
  return re.action();
}
