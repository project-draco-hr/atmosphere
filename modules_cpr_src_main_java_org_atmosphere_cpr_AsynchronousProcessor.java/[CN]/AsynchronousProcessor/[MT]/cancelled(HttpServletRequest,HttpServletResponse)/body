{
  AtmosphereResourceImpl r=null;
  long l=(Long)req.getAttribute(MAX_INACTIVE);
  if (l == -1) {
    return timedoutAction;
  }
  logger.debug("Cancelling the connection for request {}",req);
  req.setAttribute(MAX_INACTIVE,(long)-1);
  try {
    r=(AtmosphereResourceImpl)req.getAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
    if (r != null) {
      r.getAtmosphereResourceEvent().setCancelled(true);
      invokeAtmosphereHandler(r);
      try {
        r.getResponse().sendError(503);
        r.getResponse().getOutputStream().close();
      }
 catch (      Throwable t) {
        try {
          r.getResponse().getWriter().close();
        }
 catch (        Throwable t2) {
        }
      }
      r.setIsInScope(false);
    }
  }
 catch (  Throwable ex) {
    logger.debug("failed to cancel resource: " + r,ex);
  }
 finally {
    try {
      aliveRequests.remove(req);
      if (r != null) {
        r.notifyListeners();
      }
    }
  finally {
      if (r != null) {
        destroyResource(r);
      }
    }
  }
  return cancelledAction;
}
