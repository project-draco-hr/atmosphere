{
  AtmosphereResourceImpl re=null;
  long l=(Long)req.getAttribute(MAX_INACTIVE);
  if (l == -1) {
    return timedoutAction;
  }
  req.setAttribute(MAX_INACTIVE,(long)-1);
  try {
    re=(AtmosphereResourceImpl)req.getAttribute(AtmosphereServlet.ATMOSPHERE_RESOURCE);
    if (re != null) {
      re.getAtmosphereResourceEvent().setCancelled(true);
      invokeAtmosphereHandler(re);
      re.setIsInScope(false);
    }
  }
 catch (  Throwable ex) {
    if (logger.isLoggable(Level.FINE)) {
      logger.log(Level.FINE,"",ex);
    }
  }
 finally {
    try {
      aliveRequests.remove(req);
      re.notifyListeners();
    }
  finally {
      re.removeEventListeners();
      re.getBroadcaster().removeAtmosphereResource(re);
    }
  }
  return cancelledAction;
}
