{
  if (destroyed.get()) {
    return futureDone(msg);
  }
  Set<AtmosphereResource> subset=new HashSet<AtmosphereResource>();
  subset.addAll(resources);
  for (  AtmosphereResource r : resources) {
    if (!r.getAtmosphereResourceEvent().isCancelled() && sessions.contains(r.getRequest().getSession())) {
      subset.remove(r);
    }
  }
  start();
  Object newMsg=filter(msg);
  if (newMsg == null) {
    return futureDone(msg);
  }
  BroadcasterFuture<Object> f=new BroadcasterFuture<Object>(newMsg,subset.size(),this);
  messages.offer(new Entry(newMsg,subset,f,msg));
  return f;
}
