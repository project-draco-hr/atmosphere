{
  if (req.getAttribute(WebSocket.WEBSOCKET_SUSPEND) == null) {
    String key;
    String subProtocol=null;
    if (!headerContainsToken(req,"Upgrade","websocket")) {
      return delegate.doService(req,res);
    }
    if (!headerContainsToken(req,"Connection","upgrade")) {
      return delegate.doService(req,res);
    }
    if (!headerContainsToken(req,"sec-websocket-version","13")) {
      logger.debug("WebSocket version not supported. Downgrading to Comet");
      res.sendError(501,"Websocket protocol not supported");
      return new AtmosphereFramework.Action(AtmosphereFramework.Action.TYPE.CANCELLED);
    }
    key=req.getHeader("Sec-WebSocket-Key");
    if (key == null) {
      return delegate.doService(req,res);
    }
    res.setHeader("Upgrade","websocket");
    res.setHeader("Connection","upgrade");
    res.setHeader("Sec-WebSocket-Accept",getWebSocketAccept(key));
    if (subProtocol != null) {
      res.setHeader("Sec-WebSocket-Protocol",subProtocol);
    }
    HttpServletRequest hsr=req.wrappedRequest();
    while (hsr instanceof HttpServletRequestWrapper)     hsr=(HttpServletRequest)((HttpServletRequestWrapper)hsr).getRequest();
    RequestFacade facade=(RequestFacade)hsr;
    StreamInbound inbound=new TomcatWebSocketHandler(AtmosphereRequest.loadInMemory(req,true),config.framework(),config.framework().getWebSocketProtocol());
    facade.doUpgrade(inbound);
    return new AtmosphereFramework.Action(AtmosphereFramework.Action.TYPE.CREATED);
  }
  AtmosphereFramework.Action action=delegate.suspended(req,res);
  if (action.type == AtmosphereFramework.Action.TYPE.SUSPEND) {
    logger.debug("Suspending resonse: {}",res);
  }
 else   if (action.type == AtmosphereFramework.Action.TYPE.RESUME) {
    logger.debug("Resume resonse: {}",res);
    req.setAttribute(WebSocket.WEBSOCKET_RESUME,true);
  }
  return action;
}
