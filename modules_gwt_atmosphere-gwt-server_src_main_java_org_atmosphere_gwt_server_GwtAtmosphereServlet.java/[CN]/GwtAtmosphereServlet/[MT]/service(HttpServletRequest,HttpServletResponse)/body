{
  String servertransport=request.getParameter("servertransport");
  if ("rpcprotocol".equals(servertransport)) {
    Integer connectionID=Integer.parseInt(request.getParameter("connectionID"));
    doServerMessage(request.getReader(),connectionID);
    return;
  }
  AtmosphereResource<HttpServletRequest,HttpServletResponse> atm=(AtmosphereResource<HttpServletRequest,HttpServletResponse>)request.getAttribute(AtmosphereServlet.ATMOSPHERE_RESOURCE);
  if (atm == null) {
    throw new ServletException("Failed to get atmosphere resource. " + "Did you setup atmosphere.xml correctly?");
  }
  try {
    int requestHeartbeat=heartbeat;
    String requestedHeartbeat=request.getParameter("heartbeat");
    if (requestedHeartbeat != null) {
      try {
        requestHeartbeat=Integer.parseInt(requestedHeartbeat);
        if (requestHeartbeat <= 0) {
          throw new IOException("invalid heartbeat parameter");
        }
        requestHeartbeat=computeHeartbeat(requestHeartbeat);
      }
 catch (      NumberFormatException e) {
        throw new IOException("invalid heartbeat parameter");
      }
    }
    GwtAtmosphereResourceImpl resource=new GwtAtmosphereResourceImpl(atm,this,requestHeartbeat);
    doCometImpl(resource);
  }
 catch (  IOException e) {
    logger.error("Unable to initiated comet" + e.getMessage(),e);
  }
}
