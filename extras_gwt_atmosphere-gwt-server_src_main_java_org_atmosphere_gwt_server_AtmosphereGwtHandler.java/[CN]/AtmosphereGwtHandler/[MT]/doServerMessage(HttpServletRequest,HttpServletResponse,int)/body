{
  BufferedReader data=request.getReader();
  List<Serializable> postMessages=new ArrayList<Serializable>();
  GwtAtmosphereResource resource=lookupResource(connectionID);
  if (resource == null || !resource.isAlive()) {
    return;
  }
  try {
    while (true) {
      String event=data.readLine();
      if (event == null) {
        break;
      }
      String messageData=data.readLine();
      if (messageData == null) {
        break;
      }
      data.readLine();
      if (logger.isTraceEnabled()) {
        logger.trace("[" + connectionID + "] Server message received: "+ event+ ";"+ messageData.charAt(0));
      }
      if (event.equals("o")) {
        if (messageData.charAt(0) == 'p') {
          Serializable message=deserialize(messageData.substring(1));
          if (message != null) {
            postMessages.add(message);
          }
        }
 else         if (messageData.charAt(0) == 'b') {
          Serializable message=deserialize(messageData.substring(1));
          broadcast(message,resource);
        }
      }
 else       if (event.equals("s")) {
        if (messageData.charAt(0) == 'p') {
          String message=messageData.substring(1);
          postMessages.add(message);
        }
 else         if (messageData.charAt(0) == 'b') {
          Serializable message=messageData.substring(1);
          broadcast(message,resource);
        }
      }
 else       if (event.equals("c")) {
        if (messageData.equals("d")) {
          disconnect(resource);
        }
      }
    }
  }
 catch (  IOException ex) {
    logger.error("[" + connectionID + "] Failed to read",ex);
  }
  if (postMessages.size() > 0) {
    post(request,response,postMessages,resource);
  }
}
