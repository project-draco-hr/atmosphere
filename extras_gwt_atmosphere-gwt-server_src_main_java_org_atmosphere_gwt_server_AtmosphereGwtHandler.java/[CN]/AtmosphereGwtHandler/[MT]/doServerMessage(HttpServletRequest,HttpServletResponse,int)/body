{
  BufferedReader data=request.getReader();
  List<Serializable> postMessages=new ArrayList<Serializable>();
  GwtAtmosphereResource resource=lookupResource(connectionID);
  if (resource == null) {
    return;
  }
  try {
    while (true) {
      String event=data.readLine();
      if (event == null) {
        break;
      }
      String action=data.readLine();
      if (logger.isTraceEnabled()) {
        logger.trace("[" + connectionID + "] Server message received: "+ event+ ";"+ action);
      }
      if (event.equals("o")) {
        int length=Integer.parseInt(data.readLine());
        char[] messageData=new char[length];
        if (data.read(messageData,0,length) != length) {
          throw new IllegalStateException("Corrupt message received");
        }
        if (action.equals("p")) {
          Serializable message=deserialize(messageData);
          if (message != null) {
            postMessages.add(message);
          }
        }
 else         if (action.equals("b")) {
          Serializable message=deserialize(messageData);
          broadcast(message,resource);
        }
      }
 else       if (event.equals("s")) {
        int length=Integer.parseInt(data.readLine());
        char[] messageData=new char[length];
        if (data.read(messageData,0,length) != length) {
          throw new IllegalStateException("Corrupt message received");
        }
        if (action.equals("p")) {
          postMessages.add(String.copyValueOf(messageData));
        }
 else         if (action.equals("b")) {
          broadcast(String.copyValueOf(messageData),resource);
        }
      }
 else       if (event.equals("c")) {
        if (action.equals("d")) {
          disconnect(resource);
        }
      }
    }
  }
 catch (  IOException ex) {
    logger.error("[" + connectionID + "] Failed to read",ex);
  }
  if (postMessages.size() > 0) {
    post(request,response,postMessages,resource);
  }
}
