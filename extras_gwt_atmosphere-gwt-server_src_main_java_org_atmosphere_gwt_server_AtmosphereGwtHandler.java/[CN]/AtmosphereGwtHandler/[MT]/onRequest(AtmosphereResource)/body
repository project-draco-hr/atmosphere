{
  HttpServletRequest request=resource.getRequest();
  String servertransport=request.getParameter("servertransport");
  Object webSocketSubProtocol=resource.getRequest().getAttribute(FrameworkConfig.WEBSOCKET_SUBPROTOCOL);
  if ("rpcprotocol".equals(servertransport)) {
    Integer connectionID=Integer.parseInt(request.getParameter("connectionID"));
    doServerMessage(request,resource.getResponse(),connectionID);
    return;
  }
 else   if (webSocketSubProtocol != null && webSocketSubProtocol.equals(FrameworkConfig.SIMPLE_HTTP_OVER_WEBSOCKET)) {
    Integer connectionID=(Integer)request.getAttribute(AtmosphereGwtHandler.class.getName() + ".connectionID");
    doServerMessage(request,resource.getResponse(),connectionID);
    return;
  }
  try {
    int requestHeartbeat=heartbeat;
    String requestedHeartbeat=request.getParameter("heartbeat");
    if (requestedHeartbeat != null) {
      try {
        requestHeartbeat=Integer.parseInt(requestedHeartbeat);
        if (requestHeartbeat <= 0) {
          throw new IOException("invalid heartbeat parameter");
        }
        requestHeartbeat=computeHeartbeat(requestHeartbeat);
      }
 catch (      NumberFormatException e) {
        throw new IOException("invalid heartbeat parameter");
      }
    }
    GwtAtmosphereResourceImpl resourceWrapper=new GwtAtmosphereResourceImpl(resource,this,requestHeartbeat);
    request.setAttribute(AtmosphereGwtHandler.class.getName() + ".connectionID",(Integer)resourceWrapper.getConnectionID());
    doCometImpl(resourceWrapper);
  }
 catch (  IOException e) {
    logger.error("Unable to initiated comet" + e.getMessage(),e);
  }
}
