{
  firstWrite.set(true);
  if (!connection.isOpen())   throw new IOException("Connection remotely closed");
  logger.trace("WebSocket.write()");
  if (binaryWrite) {
    if (!WebSocketResponseFilter.NoOpsWebSocketResponseFilter.class.isAssignableFrom(webSocketResponseFilter.getClass())) {
      byte[] b=webSocketResponseFilter.filter(r,data,offset,length);
      if (b != null) {
        connection.sendMessage(b,0,b.length);
      }
    }
 else {
      connection.sendMessage(data,offset,length);
    }
  }
 else {
    String s=webSocketResponseFilter.filter(r,new String(data,offset,length,"UTF-8"));
    if (s != null) {
      connection.sendMessage(s);
    }
  }
  lastWrite=System.currentTimeMillis();
  return this;
}
