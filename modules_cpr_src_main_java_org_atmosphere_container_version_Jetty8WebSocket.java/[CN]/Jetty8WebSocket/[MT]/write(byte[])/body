{
  firstWrite.set(true);
  if (!connection.isOpen())   throw new IOException("Connection remotely closed");
  logger.trace("WebSocket.write()");
  String s=config.getInitParameter(ApplicationConfig.WEBSOCKET_BLOB);
  if (s != null && Boolean.parseBoolean(s)) {
    connection.sendMessage(webSocketResponseFilter.filter(data),0,data.length);
  }
 else {
    connection.sendMessage(webSocketResponseFilter.filter(new String(data,0,data.length,"UTF-8")));
  }
  lastWrite=System.currentTimeMillis();
}
