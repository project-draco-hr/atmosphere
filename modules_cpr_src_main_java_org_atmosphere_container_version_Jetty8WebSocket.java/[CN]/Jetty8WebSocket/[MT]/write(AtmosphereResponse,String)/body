{
  firstWrite.set(true);
  if (!connection.isOpen())   throw new IOException("Connection remotely closed");
  logger.trace("WebSocket.write()");
  if (binaryWrite) {
    byte[] b=webSocketResponseFilter.filter(r,data.getBytes(resource().getResponse().getCharacterEncoding()));
    connection.sendMessage(b,0,b.length);
  }
 else {
    connection.sendMessage(webSocketResponseFilter.filter(r,data));
  }
  lastWrite=System.currentTimeMillis();
}
