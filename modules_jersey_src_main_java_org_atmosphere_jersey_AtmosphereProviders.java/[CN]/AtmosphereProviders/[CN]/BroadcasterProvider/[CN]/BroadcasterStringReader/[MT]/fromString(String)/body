{
  Broadcaster broadcaster;
  try {
    AtmosphereResource<HttpServletRequest,HttpServletResponse> r=(AtmosphereResource<HttpServletRequest,HttpServletResponse>)req.getAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
    BroadcasterFactory bp=(BroadcasterFactory)req.getAttribute(ApplicationConfig.BROADCASTER_FACTORY);
    broadcaster=bp.lookup(r.getBroadcaster().getClass(),topic,true);
  }
 catch (  Throwable ex) {
    throw new WebApplicationException(ex);
  }
  req.setAttribute(AtmosphereFilter.INJECTED_BROADCASTER,broadcaster);
  return broadcaster;
}
