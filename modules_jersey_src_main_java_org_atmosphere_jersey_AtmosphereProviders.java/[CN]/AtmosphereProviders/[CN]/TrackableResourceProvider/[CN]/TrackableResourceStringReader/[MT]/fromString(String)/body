{
  TrackableResource<AtmosphereResourceImpl> trackableResource=null;
  try {
    String trackingId=req.getHeader(X_ATMOSPHERE_TRACKING_ID);
    if (trackingId == null) {
      trackingId=(String)req.getAttribute(X_ATMOSPHERE_TRACKING_ID);
    }
    if (trackingId != null) {
      trackableResource=(TrackableResource<AtmosphereResourceImpl>)TrackableSession.getDefault().lookup(trackingId);
      if (req.getAttribute(ApplicationConfig.SUPPORT_TRACKABLE) != null) {
        AtmosphereResource r=(AtmosphereResource)req.getAttribute(ATMOSPHERE_RESOURCE);
        if (trackableResource == null) {
          trackableResource=new TrackableResource<AtmosphereResourceImpl>(AtmosphereResourceImpl.class,trackingId,"");
          trackableResource.setResource(r);
        }
        logger.trace("Tracking resource of AtmosphereResource {} with {}",r.hashCode(),trackingId);
      }
      req.setAttribute(AtmosphereFilter.INJECTED_TRACKABLE,trackableResource);
    }
  }
 catch (  Throwable ex) {
    throw new WebApplicationException(ex);
  }
  return trackableResource;
}
