{
  TrackableResource<?> trackableResource=null;
  try {
    String transport=req.getHeader("X-Atmosphere-Transport");
    String trackingId=req.getHeader(TrackableResource.TRACKING_HEADER);
    if (trackingId == null) {
      trackingId=(String)req.getAttribute(TrackableResource.TRACKING_HEADER);
    }
    boolean wait=true;
    if (transport == null || transport.equalsIgnoreCase("streaming") || transport.equalsIgnoreCase("websocket")) {
      wait=false;
    }
    if (trackingId != null) {
      trackableResource=wait ? TrackableSession.getDefault().lookupAndWait(trackingId) : TrackableSession.getDefault().lookup(trackingId);
      req.setAttribute(AtmosphereFilter.INJECTED_TRACKABLE,trackableResource);
    }
  }
 catch (  Throwable ex) {
    throw new WebApplicationException(ex);
  }
  return trackableResource;
}
