{
  if (req.getAttribute(ATMOSPHERE) == null) {
    return;
  }
  CometHandler handler=ctx.getCometHandler((Integer)req.getAttribute(ATMOSPHERE));
  req.removeAttribute(ATMOSPHERE);
  if (handler == null && supportSession() && req.getSession(false) != null) {
    handler=ctx.getCometHandler((Integer)req.getSession(false).getAttribute(ATMOSPHERE));
    req.getSession().removeAttribute(ATMOSPHERE);
  }
  try {
    AtmosphereResourceImpl.class.cast(req.resource()).cancel();
  }
 catch (  IOException e) {
    logger.trace("",e);
  }
  if (handler != null && (config.getInitParameter(ApplicationConfig.RESUME_AND_KEEPALIVE) == null || config.getInitParameter(ApplicationConfig.RESUME_AND_KEEPALIVE).equalsIgnoreCase("false"))) {
    ctx.resumeCometHandler(handler);
  }
}
