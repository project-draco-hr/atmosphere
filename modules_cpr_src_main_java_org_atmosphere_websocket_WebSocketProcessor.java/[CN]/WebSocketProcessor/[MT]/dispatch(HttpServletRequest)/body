{
  if (!loggedMsg.getAndSet(true)) {
    logger.debug("Atmosphere detected WebSocket: {}",webSocket.getClass().getName());
  }
  String pathInfo=request.getPathInfo();
  String requestURI=request.getRequestURI();
  if (atmosphereServlet.getAtmosphereConfig().getWebServerName().toLowerCase().indexOf("glassfish") != -1) {
    try {
      pathInfo=pathInfo.substring(pathInfo.indexOf("/",1));
      requestURI=requestURI.substring(requestURI.indexOf("/",1));
    }
 catch (    IndexOutOfBoundsException e) {
      logger.warn("Unable to patch GlassFish WebSocket http://java.net/jira/browse/GRIZZLY-1114");
    }
  }
  WebSocketHttpServletResponse wsr=new WebSocketHttpServletResponse<WebSocket>(webSocket,webSocketProtocol,request);
  AtmosphereRequest r=new AtmosphereRequest.Builder().request(request).pathInfo(pathInfo).requestURI(requestURI).headers(configureHeader(request)).build();
  request.setAttribute(WebSocket.WEBSOCKET_SUSPEND,true);
  WebSocketAdapter.class.cast(webSocket).request(r).response(wsr);
  dispatch(r,wsr);
  webSocketProtocol.onOpen(webSocket);
  if (resource == null || !resource.getAtmosphereResourceEvent().isSuspended()) {
    webSocketProtocol.onError(webSocket,new WebSocketException("No AtmosphereResource has been suspended. The WebSocket will be closed.",wsr));
  }
}
