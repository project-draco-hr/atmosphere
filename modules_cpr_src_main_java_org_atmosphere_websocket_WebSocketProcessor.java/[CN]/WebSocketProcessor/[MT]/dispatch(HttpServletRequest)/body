{
  if (!loggedMsg.getAndSet(true)) {
    logger.debug("Atmosphere detected WebSocket: {}",webSocket.getClass().getName());
  }
  String pathInfo=request.getPathInfo();
  String requestURI=request.getRequestURI();
  if (atmosphereServlet.getAtmosphereConfig().getWebServerName().toLowerCase().indexOf("glassfish") != -1) {
    pathInfo=pathInfo.substring(pathInfo.indexOf("/",1));
    requestURI=requestURI.substring(requestURI.indexOf("/",1));
  }
  WebSocketHttpServletResponse wsr=new WebSocketHttpServletResponse<WebSocket>(webSocket,webSocketProtocol);
  AtmosphereRequest r=new AtmosphereRequest.Builder().request(request).pathInfo(pathInfo).requestURI(requestURI).headers(configureHeader(request)).build();
  request.setAttribute(WebSocket.WEBSOCKET_SUSPEND,true);
  dispatch(r,wsr);
  resource=(AtmosphereResource)request.getAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
  if (WebSocketAdapter.class.isAssignableFrom(webSocket().getClass())) {
    WebSocketAdapter.class.cast(webSocket).setAtmosphereResource(resource);
  }
  webSocketProtocol.onOpen(webSocket);
  handler=(AtmosphereHandler)request.getAttribute(FrameworkConfig.ATMOSPHERE_HANDLER);
  if (resource == null || !resource.getAtmosphereResourceEvent().isSuspended()) {
    webSocketProtocol.onError(webSocket,new WebSocketException("No AtmosphereResource has been suspended. The WebSocket will be closed.",wsr));
  }
}
