{
  if (!loggedMsg.getAndSet(true)) {
    logger.info("Atmosphere detected WebSocket: {}",webSocket.getClass().getName());
  }
  WebSocketHttpServletResponse wsr=new WebSocketHttpServletResponse<WebSocket>(webSocket);
  WebSocketHttpServletRequest r=new WebSocketHttpServletRequest.Builder().request(request).headers(configureHeader(request)).build();
  request.setAttribute(WebSocket.WEBSOCKET_SUSPEND,true);
  dispatch(r,wsr);
  resource=(AtmosphereResource)request.getAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
  handler=(AtmosphereHandler)request.getAttribute(FrameworkConfig.ATMOSPHERE_HANDLER);
  if (resource == null || !resource.getAtmosphereResourceEvent().isSuspended()) {
    logger.error("No AtmosphereResource has been suspended. The WebSocket will be closed.");
    webSocket.close();
  }
}
