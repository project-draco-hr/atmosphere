{
  if (!loggedMsg.getAndSet(true)) {
    logger.debug("Atmosphere detected WebSocket: {}",webSocket.getClass().getName());
  }
  AtmosphereResponse wsr=new AtmosphereResponse(webSocket,webSocketProtocol,request,destroyable);
  request.headers(configureHeader(request));
  request.setAttribute(WebSocket.WEBSOCKET_SUSPEND,true);
  dispatch(request,wsr);
  webSocketProtocol.onOpen(webSocket);
  if (webSocket.resource() != null) {
    if (!webSocket.resource().getAtmosphereResourceEvent().isSuspended()) {
      webSocketProtocol.onError(webSocket,new WebSocketException("No AtmosphereResource has been suspended. The WebSocket will be closed:  " + request.getRequestURI(),wsr));
    }
 else {
      request.setAttribute(ASYNCHRONOUS_HOOK,new AsynchronousProcessor.AsynchronousProcessorHook((AtmosphereResourceImpl)webSocket.resource()));
    }
  }
}
