{
  if (request == null)   return;
  try {
    framework.doCometSupport(request,r);
  }
 catch (  Throwable e) {
    logger.warn("Failed invoking AtmosphereFramework.doCometSupport()",e);
    if (e.getCause() != null) {
      e=e.getCause();
    }
    webSocketProtocol.onError(webSocket,new WebSocketException(e,new AtmosphereResponse.Builder().request(request).status(500).statusMessage(e.getMessage()).build()));
    return;
  }
  AtmosphereResource resource=(AtmosphereResource)request.getAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
  if (webSocket.resource() == null && WebSocketAdapter.class.isAssignableFrom(webSocket.getClass())) {
    WebSocketAdapter.class.cast(webSocket).setAtmosphereResource(resource);
  }
  if (r.getStatus() >= 400) {
    webSocketProtocol.onError(webSocket,new WebSocketException("Status code higher than 400",r));
  }
}
