{
  if (request == null)   return;
  try {
    framework.doCometSupport(request,r);
  }
 catch (  IOException e) {
    logger.warn("Failed invoking atmosphere servlet doCometSupport()",e);
  }
catch (  ServletException e) {
    logger.warn("Failed invoking atmosphere servlet doCometSupport()",e);
  }
  AtmosphereResource resource=(AtmosphereResource)request.getAttribute(FrameworkConfig.ATMOSPHERE_RESOURCE);
  if (webSocket.resource() == null && WebSocketAdapter.class.isAssignableFrom(webSocket.getClass())) {
    WebSocketAdapter.class.cast(webSocket).setAtmosphereResource(resource);
  }
  if (r.getStatus() >= 400) {
    webSocketProtocol.onError(webSocket,new WebSocketException("Status code higher than 400",r));
  }
}
