{
  logger.debug("WebSocket closed with {}",closeCode);
  AtmosphereResourceImpl resource=(AtmosphereResourceImpl)webSocket.resource();
  AtmosphereRequest r=resource.getRequest(false);
  AtmosphereResponse s=resource.getResponse(false);
  try {
    webSocketProtocol.onClose(webSocket);
    if (resource != null && resource.isInScope()) {
      AsynchronousProcessor.AsynchronousProcessorHook h=(AsynchronousProcessor.AsynchronousProcessorHook)r.getAttribute(ASYNCHRONOUS_HOOK);
      if (h != null) {
        if (closeCode == 1000) {
          h.timedOut();
        }
 else {
          h.closed();
        }
      }
 else {
        logger.warn("AsynchronousProcessor.AsynchronousProcessorHook was null");
      }
    }
  }
  finally {
    if (r != null && AtmosphereRequest.class.isAssignableFrom(r.getClass())) {
      r.destroy();
    }
    if (s != null && AtmosphereResponse.class.isAssignableFrom(s.getClass())) {
      s.destroy();
    }
    if (webSocket != null) {
      WebSocketAdapter.class.cast(webSocket).setAtmosphereResource(null);
    }
  }
  asyncExecutor.shutdown();
  voidExecutor.shutdown();
}
