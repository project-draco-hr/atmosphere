{
  AtmosphereResourceImpl resource=(AtmosphereResourceImpl)webSocket.resource();
  try {
    webSocketProtocol.onClose(webSocket);
    if (resource != null && resource.isInScope()) {
      AtmosphereHandler handler=(AtmosphereHandler)resource.getRequest(false).getAttribute(FrameworkConfig.ATMOSPHERE_HANDLER);
      AtmosphereResourceEventImpl e=new AtmosphereResourceEventImpl(resource,true,false);
synchronized (resource) {
        if (handler != null) {
          handler.onStateChange(e);
        }
        Meteor m=(Meteor)resource.getRequest().getAttribute(AtmosphereResourceImpl.METEOR);
        if (m != null) {
          m.destroy();
        }
      }
      try {
        resource.notifyListeners(e);
        resource.cancel();
      }
  finally {
        AsynchronousProcessor.destroyResource(resource);
      }
    }
  }
 catch (  IOException e) {
    if (resource != null && AtmosphereResourceImpl.class.isAssignableFrom(resource.getClass())) {
      AtmosphereResourceImpl.class.cast(resource).onThrowable(e);
    }
    logger.warn("Failed invoking atmosphere handler onStateChange()",e);
  }
 finally {
    if (AtmosphereRequest.class.isAssignableFrom(resource.getRequest().getClass())) {
      AtmosphereRequest.class.cast(resource.getRequest()).destroy();
    }
    if (AtmosphereResponse.class.isAssignableFrom(resource.getResponse().getClass())) {
      AtmosphereResponse.class.cast(resource.getResponse()).destroy();
    }
  }
}
