{
  AtmosphereConfig config=new AtmosphereFramework().addInitParameter(ApplicationConfig.BROADCASTER_SHARABLE_THREAD_POOLS,"true").addInitParameter(ApplicationConfig.OUT_OF_ORDER_BROADCAST,"true").getAtmosphereConfig();
  DefaultBroadcasterFactory factory=new DefaultBroadcasterFactory(DefaultBroadcaster.class,"NEVER",config);
  config.framework().setBroadcasterFactory(factory);
  broadcaster=(DefaultBroadcaster)factory.get(DefaultBroadcaster.class,"test");
  long t1=System.currentTimeMillis();
  AR2 a=new AR2();
  int count=50;
  int client=100;
  for (int i=0; i < client; i++) {
    broadcaster.addAtmosphereResource(newAR(a));
  }
  final CountDownLatch latch=new CountDownLatch(count * client);
  broadcaster.addBroadcasterListener(new BroadcasterListenerAdapter(){
    @Override public void onPostCreate(    Broadcaster b){
    }
    @Override public void onComplete(    Broadcaster b){
      latch.countDown();
    }
    @Override public void onPreDestroy(    Broadcaster b){
    }
  }
);
  for (int i=0; i < count; i++) {
    broadcaster.broadcast("message-" + i);
  }
  latch.await(60,TimeUnit.SECONDS);
  assertEquals(a.count.get(),count * client);
  System.out.println("Took: " + (System.currentTimeMillis() - t1));
}
