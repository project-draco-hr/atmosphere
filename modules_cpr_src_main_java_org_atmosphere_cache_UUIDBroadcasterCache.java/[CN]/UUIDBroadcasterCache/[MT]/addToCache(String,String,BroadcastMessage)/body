{
  if (logger.isTraceEnabled()) {
    logger.trace("Adding for AtmosphereResource {} cached messages {}",uuid,message.message());
    logger.trace("Active clients {}",activeClients());
  }
  String messageId=UUID.randomUUID().toString();
  boolean cache=true;
  if (!inspect(message)) {
    cache=false;
  }
  CacheMessage cacheMessage=new CacheMessage(messageId,message.message(),uuid);
  ;
  if (cache) {
    if (uuid.equals(NULL)) {
      for (      Map.Entry<String,Long> entry : activeClients.entrySet()) {
        addMessageIfNotExists(broadcasterId,entry.getKey(),cacheMessage);
      }
    }
 else {
      cacheCandidate(broadcasterId,uuid);
      addMessageIfNotExists(broadcasterId,uuid,cacheMessage);
    }
  }
  return cacheMessage;
}
