{
  Object e=message.message;
  if (logger.isTraceEnabled()) {
    logger.trace("Adding for AtmosphereResource {} cached messages {}",clientId,e);
    logger.trace("Active clients {}",activeClients());
  }
  String messageId=UUID.randomUUID().toString();
  CacheMessage cacheMessage=new CacheMessage(messageId,e,clientId);
  if (clientId.equals(NULL)) {
    for (    Map.Entry<String,Long> entry : activeClients.entrySet()) {
      addMessageIfNotExists(broadcasterId,entry.getKey(),cacheMessage);
    }
  }
 else {
    cacheCandidate(broadcasterId,clientId);
    addMessageIfNotExists(broadcasterId,clientId,cacheMessage);
  }
  return cacheMessage;
}
