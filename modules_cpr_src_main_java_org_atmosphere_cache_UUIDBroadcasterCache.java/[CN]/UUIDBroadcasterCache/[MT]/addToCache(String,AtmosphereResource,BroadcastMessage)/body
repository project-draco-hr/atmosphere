{
  if (r != null && !bannedResources.isEmpty()) {
    List<String> list=bannedResources.get(broadcasterId);
    if (list != null && list.contains(r.uuid())) {
      logger.debug("Resource {} is not allowed to cache message {} with broadcaster " + broadcasterId,r.uuid(),message);
      return null;
    }
  }
  Object e=message.message;
  if (logger.isTraceEnabled()) {
    logger.trace("Adding for AtmosphereResource {} cached messages {}",r != null ? r.uuid() : "null",e);
    logger.trace("Active clients {}",activeClients());
  }
  long now=System.currentTimeMillis();
  String messageId=UUID.randomUUID().toString();
  CacheMessage cacheMessage=new CacheMessage(messageId,e);
synchronized (messages) {
    if (r == null) {
      for (      Map.Entry<String,Long> entry : activeClients.entrySet()) {
        addMessageIfNotExists(entry.getKey(),cacheMessage);
      }
    }
 else {
      String clientId=uuid(r);
      activeClients.put(clientId,now);
      addMessageIfNotExists(clientId,cacheMessage);
    }
  }
  return cacheMessage;
}
