{
  if (!BaseServerWebSocket.class.isAssignableFrom(w.getClass())) {
    throw new IllegalStateException();
  }
  BaseServerWebSocket webSocket=BaseServerWebSocket.class.cast(w);
  try {
    webSocketProcessor=(WebSocketProcessor)GrizzlyWebSocket.class.getClassLoader().loadClass(config.getServlet().getWebSocketProcessorClassName()).getDeclaredConstructor(new Class[]{AtmosphereServlet.class,WebSocket.class}).newInstance(new Object[]{config.getServlet(),new GrizzlyWebSocket(webSocket)});
    webSocketProcessor.connect(new HttpServletRequestWrapper(webSocket.getRequest()));
  }
 catch (  Exception e) {
    logger.warn("failed to connect to web socket",e);
  }
}
