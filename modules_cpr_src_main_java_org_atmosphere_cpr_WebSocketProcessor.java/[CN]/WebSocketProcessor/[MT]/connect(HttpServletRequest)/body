{
  if (!loggedMsg.getAndSet(true)) {
    AtmosphereServlet.logger.info("Atmosphere detected WebSocketSupport: " + webSocketSupport.getClass().getName());
  }
  atmosphereServlet.addInitParameter(AtmosphereServlet.SUSPEND_WITHOUT_COMMENT,"true");
  request.setAttribute(WebSocketSupport.WEBSOCKET_SUSPEND,"true");
  try {
    atmosphereServlet.doCometSupport(request,new WebSocketHttpServletResponse<WebSocketSupport>(webSocketSupport));
  }
 catch (  IOException e) {
    AtmosphereServlet.logger.log(Level.INFO,"",e);
  }
catch (  ServletException e) {
    AtmosphereServlet.logger.log(Level.INFO,"",e);
  }
  r=(AtmosphereResource)request.getAttribute(AtmosphereServlet.ATMOSPHERE_RESOURCE);
  ah=(AtmosphereHandler)request.getAttribute(AtmosphereServlet.ATMOSPHERE_HANDLER);
  if (!r.getAtmosphereResourceEvent().isSuspended()) {
    webSocketSupport.close();
  }
}
