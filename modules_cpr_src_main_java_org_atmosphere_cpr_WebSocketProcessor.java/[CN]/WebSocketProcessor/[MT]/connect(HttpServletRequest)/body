{
  if (!loggedMsg.getAndSet(true)) {
    logger.info("Atmosphere detected WebSocketSupport: {}",webSocketSupport.getClass().getName());
  }
  WebSocketHttpServletResponse wsr=new WebSocketHttpServletResponse<WebSocketSupport>(webSocketSupport);
  request.setAttribute(WebSocketSupport.WEBSOCKET_SUSPEND,"true");
  try {
    atmosphereServlet.doCometSupport(request,wsr);
  }
 catch (  IOException e) {
    logger.info("failed invoking atmosphere servlet doCometSupport()",e);
  }
catch (  ServletException e) {
    logger.info("failed invoking atmosphere servlet doCometSupport()",e);
  }
  resource=(AtmosphereResource)request.getAttribute(AtmosphereServlet.ATMOSPHERE_RESOURCE);
  handler=(AtmosphereHandler)request.getAttribute(AtmosphereServlet.ATMOSPHERE_HANDLER);
  if (resource == null || !resource.getAtmosphereResourceEvent().isSuspended()) {
    logger.error("No AtmosphereResource has been suspended. The WebSocket will be closed.");
    webSocketSupport.close();
  }
}
