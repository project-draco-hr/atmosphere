{
  firstWrite.set(true);
  if (b == null) {
    logger.error("Cannot write null value for {}",resource());
    return this;
  }
  if (!isOpen())   throw new IOException("Connection remotely closed");
  logger.trace("WebSocket.write()");
  boolean transform=filters.size() > 0 && r.getStatus() < 400;
  if (binaryWrite || r.resource().forceBinaryWrite()) {
    if (transform) {
      b=transform(b,offset,length);
    }
    if (b != null) {
      write(b,0,length);
    }
  }
 else {
    String data=null;
    String charset=r.getCharacterEncoding() == null ? "UTF-8" : r.getCharacterEncoding();
    if (transform) {
      data=new String(transform(b,offset,length),charset);
    }
 else {
      data=new String(b,offset,length,charset);
    }
    if (data != null) {
      write(data);
    }
  }
  lastWrite=System.currentTimeMillis();
  return this;
}
