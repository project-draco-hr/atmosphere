{
  firstWrite.set(true);
  if (!isOpen())   throw new IOException("Connection remotely closed");
  logger.trace("WebSocket.write()");
  boolean transform=filters.size() > 0 && r.getStatus() < 400;
  if (binaryWrite) {
    byte[] b=data.getBytes(resource().getResponse().getCharacterEncoding());
    if (transform) {
      b=transform(b,0,b.length);
    }
    if (b != null) {
      write(b,0,b.length);
    }
  }
 else {
    if (transform) {
      byte[] b=data.getBytes(resource().getResponse().getCharacterEncoding());
      data=new String(transform(b,0,b.length),r.getCharacterEncoding());
    }
    if (data != null) {
      write(data);
    }
  }
  lastWrite=System.currentTimeMillis();
  return this;
}
