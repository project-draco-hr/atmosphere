{
  firstWrite.set(true);
  logger.trace("WebSocket.write()");
  if (binaryWrite) {
    outbound.writeBinaryMessage(ByteBuffer.wrap(webSocketResponseFilter.filter(r,data).getBytes(resource().getResponse().getCharacterEncoding())));
  }
 else {
    outbound.writeTextMessage(CharBuffer.wrap(webSocketResponseFilter.filter(r,data)));
  }
  lastWrite=System.currentTimeMillis();
  return this;
}
