{
  firstWrite.set(true);
  logger.trace("WebSocket.write()");
  if (binaryWrite) {
    if (!WebSocketResponseFilter.NoOpsWebSocketResponseFilter.class.isAssignableFrom(webSocketResponseFilter.getClass())) {
      byte[] b=webSocketResponseFilter.filter(r,data,offset,length);
      outbound.writeBinaryMessage(ByteBuffer.wrap(b));
    }
 else {
      outbound.writeBinaryMessage(ByteBuffer.wrap(data,offset,length));
    }
  }
 else {
    outbound.writeTextMessage(CharBuffer.wrap(webSocketResponseFilter.filter(r,new String(data,offset,length,resource().getResponse().getCharacterEncoding()))));
  }
  lastWrite=System.currentTimeMillis();
}
