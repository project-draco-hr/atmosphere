{
  logger.info("WebSocket upgrade requested");
  return new WebSocket(){
    private WebSocketProcessor webSocketProcessor;
    @Override public void onConnect(    WebSocket.Outbound outbound){
      webSocketProcessor=new WebSocketProcessor(AtmosphereServlet.this,new JettyWebSocketSupport(outbound));
      try {
        webSocketProcessor.connect(new JettyRequestFix(request));
      }
 catch (      IOException e) {
        logger.warn("failed to connect to web socket",e);
      }
    }
    @Override public void onMessage(    byte frame,    String data){
      webSocketProcessor.broadcast(frame,data);
    }
    @Override public void onMessage(    byte frame,    byte[] data,    int offset,    int length){
      webSocketProcessor.broadcast(frame,new String(data,offset,length));
    }
    @Override public void onFragment(    boolean more,    byte opcode,    byte[] data,    int offset,    int length){
      webSocketProcessor.broadcast(opcode,new String(data,offset,length));
    }
    @Override public void onDisconnect(){
      webSocketProcessor.close();
    }
  }
;
}
