{
  HttpServletRequest req=cometEvent.getHttpServletRequest();
  HttpServletResponse res=cometEvent.getHttpServletResponse();
  req.setAttribute(TomcatCometSupport.COMET_EVENT,cometEvent);
  if (!framework.getAsyncSupport().supportWebSocket()) {
    if (!framework.isCometSupportSpecified && !framework.isCometSupportConfigured.getAndSet(true)) {
synchronized (framework.asyncSupport) {
        if (!framework.asyncSupport.getClass().equals(TomcatCometSupport.class)) {
          AsyncSupport current=framework.asyncSupport;
          logger.warn("TomcatCometSupport is enabled, switching to it");
          framework.asyncSupport=new TomcatCometSupport(framework.config);
          if (current instanceof AsynchronousProcessor) {
            ((AsynchronousProcessor)current).shutdown();
          }
          framework.asyncSupport.init(framework.config.getServletConfig());
        }
      }
    }
  }
  framework.doCometSupport(AtmosphereRequest.wrap(req),AtmosphereResponse.wrap(res));
  String transport=cometEvent.getHttpServletRequest().getParameter(HeaderConfig.X_ATMOSPHERE_TRANSPORT);
  if (transport != null && transport.equalsIgnoreCase(HeaderConfig.WEBSOCKET_TRANSPORT)) {
    cometEvent.close();
  }
}
