{
  if (broadcasterFactory == null) {
    Class bc=(Class<Broadcaster>)Thread.currentThread().getContextClassLoader().loadClass(broadcasterClassName);
    broadcasterFactory=new DefaultBroadcasterFactory(bc);
    config.broadcasterFactory=broadcasterFactory;
  }
  Iterator<Entry<String,AtmosphereHandlerWrapper>> i=atmosphereHandlers.entrySet().iterator();
  AtmosphereHandlerWrapper w;
  Entry<String,AtmosphereHandlerWrapper> e;
  while (i.hasNext()) {
    e=i.next();
    w=e.getValue();
    BroadcasterConfig broadcasterConfig=new BroadcasterConfig(broadcasterFilters);
    if (w.broadcaster == null) {
      w.broadcaster=broadcasterFactory.get();
    }
 else {
      w.broadcaster.setBroadcasterConfig(broadcasterConfig);
      if (broadcasterCacheClassName != null) {
        BroadcasterCache cache=(BroadcasterCache)Thread.currentThread().getContextClassLoader().loadClass(broadcasterCacheClassName).newInstance();
        InjectorProvider.getInjector().inject(cache);
        broadcasterConfig.setBroadcasterCache(cache);
      }
    }
    w.broadcaster.setID(e.getKey());
  }
  logger.info("Using " + broadcasterClassName);
}
