{
  final AtmosphereRequest request=r.getRequest();
  final AtmosphereResponse response=r.getResponse();
  if (r.transport().equals(AtmosphereResource.TRANSPORT.JSONP)) {
    super.inspect(r);
    AsyncIOWriter writer=response.getAsyncIOWriter();
    if (AtmosphereInterceptorWriter.class.isAssignableFrom(writer.getClass())) {
      AtmosphereInterceptorWriter.class.cast(writer).interceptor(new AsyncIOInterceptor(){
        String contentType(){
          String c=response.getContentType();
          if (c == null) {
            c=(String)request.getAttribute(FrameworkConfig.EXPECTED_CONTENT_TYPE);
          }
          if (c == null) {
            c=request.getContentType();
          }
          return c;
        }
        String callbackName(){
          return request.getParameter(HeaderConfig.JSONP_CALLBACK_NAME);
        }
        @Override public void intercept(        AtmosphereResponse response,        String data){
          String contentType=contentType();
          String callbackName=callbackName();
          if (!data.startsWith("\"") && !contentType.contains("json")) {
            data=callbackName + "({\"message\" : \"" + data+ "\"});";
          }
 else {
            data=callbackName + "({\"message\" :" + data+ "});";
          }
          response.write(data);
        }
        @Override public void intercept(        AtmosphereResponse response,        byte[] data){
          String contentType=contentType();
          String callbackName=callbackName();
          if (contentType != null && !contentType.contains("json")) {
            response.write(callbackName + "({\"message\" : \"").write(data).write("\"});");
          }
 else {
            response.write(callbackName + "({\"message\" :").write(data).write("});");
          }
        }
        @Override public void intercept(        AtmosphereResponse response,        byte[] data,        int offset,        int length){
          String contentType=contentType();
          String callbackName=callbackName();
          if (contentType != null && !contentType.contains("json")) {
            response.write(callbackName + "({\"message\" : \"").write(data,offset,length).write("\"});");
          }
 else {
            response.write(callbackName + "({\"message\" :").write(data,offset,length).write("});");
          }
        }
      }
);
    }
 else {
      throw new IllegalStateException("AsyncIOWriter must be an instance of " + AsyncIOWriter.class.getName());
    }
  }
  return Action.CONTINUE;
}
